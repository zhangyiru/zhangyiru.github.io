<!DOCTYPE html>
<html lang=zh-CN>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta property="og:description" content="">
    <meta property="og:type" content="website">
    <meta name="description" content="">
    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
        系统启动异常进入recovery模式 - zddzdd
        
    </title>

    <!-- Custom CSS -->
    
<link rel="stylesheet" href="/css/aircloud.css">

    
<link rel="stylesheet" href="/css/gitment.css">

    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_28hi1hpxx24.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>

    









<meta name="generator" content="Hexo 7.1.1"><link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
</head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i>  </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar ">
		<img src="/img/wanwan.jpg" class="js-avatar show"/>
	</div>
        <div class="name">
            <i>Xayahion</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li >
                <a href="/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>主页</span>
                </a>
            </li>
            <li >
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>标签</span>
                </a>
            </li>
            <li >
                <a href="/archives">
                    <i class="iconfont icon-guidang2"></i>
                    <span>存档</span>
                </a>
            </li>
            <li >
                <a href="/collect/">
                    <i class="iconfont icon-shoucang1"></i>
                    <span>收藏</span>
                </a>
            </li>
            <li >
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>关于</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E8%83%8C%E6%99%AF"><span class="toc-text">1.背景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-resize-f2fs"><span class="toc-text">2.resize_f2fs</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%96%91%E9%97%AE1%EF%BC%9A%E8%AF%BB%E5%8F%96f2fs%E7%9A%84%E8%B6%85%E7%BA%A7%E5%9D%97%E4%BF%A1%E6%81%AF%E6%88%90%E5%8A%9F%EF%BC%8C%E4%B8%BA%E5%95%A5%E8%A6%81%E8%BF%9B%E8%A1%8Cresize-f2fs%E6%93%8D%E4%BD%9C%EF%BC%9F"><span class="toc-text">疑问1：读取f2fs的超级块信息成功，为啥要进行resize f2fs操作？</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-fsck-f2fs"><span class="toc-text">3.fsck.f2fs</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%96%91%E9%97%AE2%EF%BC%9Aino-948%E5%B0%91%E4%BA%86recover-dentry%E6%B5%81%E7%A8%8B%EF%BC%9F"><span class="toc-text">疑问2：ino&#x3D;948少了recover_dentry流程？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%96%91%E9%97%AE3%EF%BC%9A%E5%B0%9D%E8%AF%95%E6%9C%AC%E5%9C%B0%E5%A4%8D%E7%8E%B0%E6%9F%A5%E7%9C%8B%E6%B2%A1%E5%8A%A0resize-f2fs%E7%9A%84logcat%E6%97%A5%E5%BF%97%E4%B8%AD%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8fsck%E7%9A%84%E6%8A%A5%E9%94%99%EF%BC%8C%E5%A6%82%E6%9E%9C%E6%9C%89%E8%AF%B4%E6%98%8E%E5%92%8Cresize-f2fs%E6%97%A0%E5%85%B3"><span class="toc-text">疑问3：尝试本地复现查看没加resize.f2fs的logcat日志中是否存在fsck的报错，如果有说明和resize.f2fs无关</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-oops"><span class="toc-text">4.oops</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-WARN-ON%E6%89%93%E5%8D%B0"><span class="toc-text">4.1 WARN_ON打印</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-Unable-to-handle-kernel-paging-request-at-virtual-address"><span class="toc-text">4.2 Unable to handle kernel paging request at virtual address</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%8D%E6%B1%87%E7%BC%96"><span class="toc-text">反汇编</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#memcpy"><span class="toc-text">memcpy</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#x1%E5%AF%84%E5%AD%98%E5%99%A8%E7%9A%84%E8%B5%8B%E5%80%BC%E6%83%85%E5%86%B5%EF%BC%8C%E6%88%AA%E6%96%AD%E5%88%B0memcpy"><span class="toc-text">x1寄存器的赋值情况，截断到memcpy</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8C%9C%E6%B5%8B%EF%BC%9Af2fs%E4%B8%80%E8%87%B4%E6%80%A7%E6%8D%9F%E5%9D%8F%EF%BC%8C%E5%BD%93%E5%9B%9E%E5%86%99%E6%97%B6%E8%A7%A6%E5%8F%91oops"><span class="toc-text">猜测：f2fs一致性损坏，当回写时触发oops</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-change-curseg"><span class="toc-text">4.3 change_curseg</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-ARM%E8%99%9A%E6%8B%9F%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4%E5%B8%83%E5%B1%80"><span class="toc-text">5.ARM虚拟地址空间布局</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-f2fs%E4%B8%8D%E4%B8%80%E8%87%B4"><span class="toc-text">6.f2fs不一致</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-invalid-blkaddr"><span class="toc-text">6.1 invalid blkaddr</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%A5%E5%BF%97"><span class="toc-text">日志</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B"><span class="toc-text">流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#pvec%E5%8F%82%E6%95%B0%E4%BC%A0%E9%80%92%E6%B5%81%E7%A8%8B"><span class="toc-text">pvec参数传递流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#f2fs-sm-info"><span class="toc-text">f2fs_sm_info</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-inconsistent-node-block"><span class="toc-text">6.2 inconsistent node block</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%A6%E4%B8%80%E7%A7%8D%E6%8A%A5%E9%94%99"><span class="toc-text">另一种报错</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%96%91%E9%97%AE4%EF%BC%9A%E7%9B%B4%E6%8E%A5%E5%AF%B9%E8%A3%B8%E8%AE%BE%E5%A4%87%E6%8C%89%E7%85%A7%E7%89%A9%E7%90%86%E5%9C%B0%E5%9D%80%E5%86%99%E6%93%8D%E4%BD%9C%EF%BC%8C%E7%A0%B4%E5%9D%8F%E4%BA%86%E5%85%B3%E9%94%AE%E6%96%87%E4%BB%B6%E7%9A%84node%E6%95%B0%E6%8D%AE%E5%8C%BA%E5%9F%9F%EF%BC%9B%E9%82%A3%E4%B9%88%E4%B8%BA%E5%95%A5%E5%A2%9E%E5%88%A0%E6%96%87%E4%BB%B6%E4%BC%9A%E5%A4%8D%E7%8E%B0"><span class="toc-text">疑问4：直接对裸设备按照物理地址写操作，破坏了关键文件的node数据区域；那么为啥增删文件会复现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-%E6%9F%A5%E7%9C%8Bdata%E5%88%86%E5%8C%BA"><span class="toc-text">7.查看data分区</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-dump-f2fs"><span class="toc-text">8.dump.f2fs</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Invalid-SB-CRC-offset"><span class="toc-text">Invalid SB CRC offset</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Magic-Mismatch-valid"><span class="toc-text">Magic Mismatch, valid</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Can%E2%80%99t-find-a-valid"><span class="toc-text">Can’t find a valid</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%A3%E5%B8%B8%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F"><span class="toc-text">正常文件系统</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#SIT%E9%83%A8%E5%88%86"><span class="toc-text">SIT部分</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SSA%E9%83%A8%E5%88%86"><span class="toc-text">SSA部分</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#NAT%E9%83%A8%E5%88%86"><span class="toc-text">NAT部分</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-%E5%9B%9E%E5%86%99"><span class="toc-text">9.回写</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#9-1-%E6%8A%A5%E9%94%99%E8%B0%83%E7%94%A8%E6%A0%88"><span class="toc-text">9.1 报错调用栈</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-2-%E5%B0%9D%E8%AF%95%E5%A4%8D%E7%8E%B0"><span class="toc-text">9.2 尝试复现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%A0%E6%89%93%E5%8D%B0%E5%8F%91%E7%8E%B0%E6%AD%A3%E5%B8%B8%E6%B5%81%E7%A8%8B%E4%B9%9F%E4%BC%9A%E8%B5%B0%E5%88%B0"><span class="toc-text">加打印发现正常流程也会走到</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-%E5%A4%8D%E7%8E%B0"><span class="toc-text">10.复现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-10%E9%97%AE%E9%A2%98%E8%BF%9B%E5%B1%95%E5%90%8C%E6%AD%A5"><span class="toc-text">3-10问题进展同步</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E6%8F%8F%E8%BF%B0"><span class="toc-text">问题描述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BD%93%E5%89%8D%E8%BF%9B%E5%B1%95%EF%BC%9A"><span class="toc-text">当前进展：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%86%E5%8F%B2%E8%BF%9B%E5%B1%95%EF%BC%9A"><span class="toc-text">历史进展：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%A1%E5%88%92%EF%BC%9A"><span class="toc-text">计划：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="toc-text">参考链接</span></a></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-bg" id="search-bg"></div>
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input"/>
            <span id="begin-search">搜索</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>

        <div class="index-about-mobile">
            <i>  </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        系统启动异常进入recovery模式
    </div>

    <div class="post-meta">
        <span class="attr">发布于：<span>2024-03-27 15:12:51</span></span>
        
        <span class="attr">标签：/
        
        <a class="tag" href="/tags/#problem" title="problem">problem</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">访问：<span id="busuanzi_value_page_pv"></span>
</span>
</span>
    </div>
    <div class="post-content ">
        <h2 id="1-背景"><a href="#1-背景" class="headerlink" title="1.背景"></a>1.背景</h2><p>系统启动后蓝灯一直闪烁，重启也是相同的现象。</p>
<p>拆机后连接串口，开机启动，一直报recover_data，经过一段很长的时间后，系统恢复正常</p>
<p><img src="C:\Users\rokid\AppData\Roaming\Typora\typora-user-images\image-20240228112100344.png" alt="image-20240228112100344"></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">binder::Status <span class="title">VoldNativeService::mountFstab</span><span class="params">(<span class="type">const</span> std::string&amp; blkDevice,</span></span></span><br><span class="line"><span class="params"><span class="function">                                             <span class="type">const</span> std::string&amp; mountPoint)</span> </span>&#123;</span><br><span class="line">    ENFORCE_SYSTEM_OR_ROOT;</span><br><span class="line">    ACQUIRE_LOCK;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">translateBool</span>(</span><br><span class="line">            <span class="built_in">fscrypt_mount_metadata_encrypted</span>(blkDevice, mountPoint, <span class="literal">false</span>, <span class="literal">false</span>, <span class="string">&quot;null&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<blockquote>
<p>Usage: fsck.f2fs [options] device<br>[options]:<br>  -a check&#x2F;fix potential corruption, reported by f2fs<br>  -c <num-cache-entry>  set number of cache entries (default 0)<br>  -m <max-hash-collision>  set max cache hash collision (default 16)<br>  -C encoding[:flag1,flag2] Set options for enabling casefolding<br>  -d debug level [default:0]<br>  -f check&#x2F;fix entire partition<br>  -g add default options<br>  -l show superblock&#x2F;checkpoint<br>  -O feature1[feature2,feature3,…] e.g. “encrypt”<br>  -p preen mode [default:0 the same as -a [0|1]]<br>  -S sparse_mode<br>  -t show directory tree<br>  -q preserve quota limits<br>  -y fix all the time<br>  -V print the version number and exit<br>  –dry-run do not really fix corruptions<br>  –no-kernel-check skips detecting kernel change<br>  –kernel-check checks kernel change<br>  –debug-cache to debug cache when -c is used</p>
</blockquote>
<p>1.查看日志是进行fsck修复工作</p>
<p>2.本地暂时无法执行fsck操作，无法进行umount data分区的操作</p>
<h2 id="2-resize-f2fs"><a href="#2-resize-f2fs" class="headerlink" title="2.resize_f2fs"></a>2.resize_f2fs</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (is_f2fs(entry.fs_type)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!read_f2fs_superblock(blk_device, &amp;fs_stat)) &#123;</span><br><span class="line">        <span class="keyword">return</span> fs_stat;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*add for resizeof /data/ 20231019 ,for recovery-mode*/</span></span><br><span class="line">    <span class="meta">#<span class="keyword">ifdef</span> RECOVERY_MODE_BUG</span></span><br><span class="line">    LINFO &lt;&lt; <span class="string">&quot;resize_f2fs set &quot;</span>;</span><br><span class="line">    resize_f2fs(blk_device);</span><br><span class="line">    <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">bool</span> <span class="title function_">read_f2fs_superblock</span><span class="params">(<span class="type">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; blk_device, <span class="type">int</span>* fs_stat)</span> &#123;</span><br><span class="line">    android::base::unique_fd <span class="title function_">fd</span><span class="params">(TEMP_FAILURE_RETRY(open(blk_device.c_str(), O_RDONLY | O_CLOEXEC)))</span>;</span><br><span class="line">    __le32 sb1, sb2;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        PERROR &lt;&lt; <span class="string">&quot;Failed to open &#x27;&quot;</span> &lt;&lt; blk_device &lt;&lt; <span class="string">&quot;&#x27;&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (TEMP_FAILURE_RETRY(pread(fd, &amp;sb1, <span class="keyword">sizeof</span>(sb1), F2FS_SUPER_OFFSET)) != <span class="keyword">sizeof</span>(sb1)) &#123;</span><br><span class="line">        PERROR &lt;&lt; <span class="string">&quot;Can&#x27;t read &#x27;&quot;</span> &lt;&lt; blk_device &lt;&lt; <span class="string">&quot;&#x27; superblock1&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (TEMP_FAILURE_RETRY(pread(fd, &amp;sb2, <span class="keyword">sizeof</span>(sb2), F2FS_BLKSIZE + F2FS_SUPER_OFFSET)) !=</span><br><span class="line">        <span class="keyword">sizeof</span>(sb2)) &#123;</span><br><span class="line">        PERROR &lt;&lt; <span class="string">&quot;Can&#x27;t read &#x27;&quot;</span> &lt;&lt; blk_device &lt;&lt; <span class="string">&quot;&#x27; superblock2&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sb1 != cpu_to_le32(F2FS_SUPER_MAGIC) &amp;&amp; sb2 != cpu_to_le32(F2FS_SUPER_MAGIC)) &#123;</span><br><span class="line">        LINFO &lt;&lt; <span class="string">&quot;Invalid f2fs superblock on &#x27;&quot;</span> &lt;&lt; blk_device &lt;&lt; <span class="string">&quot;&#x27;&quot;</span>;</span><br><span class="line">        *fs_stat |= FS_STAT_INVALID_MAGIC;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="疑问1：读取f2fs的超级块信息成功，为啥要进行resize-f2fs操作？"><a href="#疑问1：读取f2fs的超级块信息成功，为啥要进行resize-f2fs操作？" class="headerlink" title="疑问1：读取f2fs的超级块信息成功，为啥要进行resize f2fs操作？"></a>疑问1：读取f2fs的超级块信息成功，为啥要进行resize f2fs操作？</h3><p>确保文件系统大小和实际的剩余文件系统大小空间一致</p>
<blockquote>
<p>01-01 08:00:21.121   695   695 I vold    : [libfs_mgr]resize_f2fs set<br>01-01 08:00:21.121   695   695 I vold    : [libfs_mgr]Running &#x2F;system&#x2F;bin&#x2F;resize.f2fs -s&#x2F;dev&#x2F;block&#x2F;dm-20<br>01-01 08:00:21.134     0     0 I resize.f2fs: Info: No support kernel version!<br>01-01 08:00:21.140     0     0 I resize.f2fs: Info: Segments per section &#x3D; 1<br>01-01 08:00:21.145     0     0 I resize.f2fs: Info: Sections per zone &#x3D; 1<br>01-01 08:00:21.150     0     0 I resize.f2fs: Info: sector size &#x3D; 4096<br>01-01 08:00:21.155     0     0 I resize.f2fs: Info: total sectors &#x3D; 27395539 (107013 MB)<br>01-01 08:00:21.161     0     0 I resize.f2fs: Info: MKFS version<br>01-01 08:00:21.166     0     0 I resize.f2fs: “5.4.0-164-generic #181-Ubuntu SMP Fri Sep 1 13:41:22 UTC 2023”<br>01-01 08:00:21.174     0     0 I resize.f2fs: Info: FSCK version<br>01-01 08:00:21.179     0     0 I resize.f2fs: from “4.19.157-perf”<br>01-01 08:00:21.183     0     0 I resize.f2fs: to “4.19.157-perf”<br>01-01 08:00:21.180   695   695 I vold    : [libfs_mgr]resize.f2fs returned status 0xff00</p>
</blockquote>
<p>0xff00返回值含义？</p>
<h2 id="3-fsck-f2fs"><a href="#3-fsck-f2fs" class="headerlink" title="3.fsck.f2fs"></a>3.fsck.f2fs</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//mount前对fs进行操作</span></span><br><span class="line">prepare_fs_for_mount</span><br><span class="line">	resize_f2fs</span><br><span class="line">    check_fs</span><br><span class="line">		fsck.<span class="function">f2fs</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="keyword">else</span> <span class="title">if</span> <span class="params">(is_f2fs(fs_type))</span> </span>&#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* f2fs_fsck_argv[] = &#123;F2FS_FSCK_BIN,     <span class="string">&quot;-a&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;10000&quot;</span>, <span class="string">&quot;--debug-cache&quot;</span>,</span><br><span class="line">                                    blk_device.<span class="built_in">c_str</span>()&#125;;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* f2fs_fsck_forced_argv[] = &#123;</span><br><span class="line">            F2FS_FSCK_BIN, <span class="string">&quot;-f&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;10000&quot;</span>, <span class="string">&quot;--debug-cache&quot;</span>, blk_device.<span class="built_in">c_str</span>()&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">should_force_check</span>(*fs_stat)) &#123;</span><br><span class="line">        LINFO &lt;&lt; <span class="string">&quot;Running &quot;</span> &lt;&lt; F2FS_FSCK_BIN &lt;&lt; <span class="string">&quot; -f -c 10000 --debug-cache &quot;</span></span><br><span class="line">              &lt;&lt; <span class="built_in">realpath</span>(blk_device);</span><br><span class="line">        ret = <span class="built_in">logwrap_fork_execvp</span>(<span class="built_in">ARRAY_SIZE</span>(f2fs_fsck_forced_argv), f2fs_fsck_forced_argv,</span><br><span class="line">                                  &amp;status, <span class="literal">false</span>, LOG_KLOG | LOG_FILE, <span class="literal">false</span>, <span class="literal">nullptr</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        LINFO &lt;&lt; <span class="string">&quot;Running &quot;</span> &lt;&lt; F2FS_FSCK_BIN &lt;&lt; <span class="string">&quot; -a -c 10000 --debug-cache &quot;</span></span><br><span class="line">              &lt;&lt; <span class="built_in">realpath</span>(blk_device);</span><br><span class="line">        ret = <span class="built_in">logwrap_fork_execvp</span>(<span class="built_in">ARRAY_SIZE</span>(f2fs_fsck_argv), f2fs_fsck_argv, &amp;status, <span class="literal">false</span>,</span><br><span class="line">                                  LOG_KLOG | LOG_FILE, <span class="literal">false</span>, <span class="literal">nullptr</span>); <span class="comment">//called</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><img src="C:\Users\rokid\AppData\Roaming\Typora\typora-user-images\image-20240228115248075.png" alt="image-20240228115248075"></p>
<p>recover_inode -&gt; recover_dentry -&gt; recover_data</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">f2fs_fill_super</span><br><span class="line">	f2fs_recover_fsync_data</span><br><span class="line">		recover_data</span><br><span class="line">			recover_inode</span><br><span class="line">			recover_dentry</span><br><span class="line">			do_recover_data</span><br></pre></td></tr></table></figure>

<p>​		</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//fs/f2fs/recovery.c</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">recover_inode</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> page *page)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    f2fs_notice(F2FS_I_SB(inode), <span class="string">&quot;recover_inode: ino = %x, name = %s, inline = %x&quot;</span>,</span><br><span class="line">                    ino_of_node(page), name, raw-&gt;i_inline);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">recover_data</span><span class="params">(<span class="keyword">struct</span> f2fs_sb_info *sbi, <span class="keyword">struct</span> list_head *inode_list,</span></span><br><span class="line"><span class="params">                <span class="keyword">struct</span> list_head *tmp_inode_list, <span class="keyword">struct</span> list_head *dir_list)</span></span><br><span class="line">&#123;</span><br><span class="line">	...</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		...</span><br><span class="line">		<span class="keyword">if</span> (IS_INODE(page)) &#123;</span><br><span class="line">            err = recover_inode(entry-&gt;inode, page); <span class="comment">//called</span></span><br><span class="line">            <span class="keyword">if</span> (err) &#123;</span><br><span class="line">                    f2fs_put_page(page, <span class="number">1</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (entry-&gt;last_dentry == blkaddr) &#123;</span><br><span class="line">            err = recover_dentry(entry-&gt;inode, page, dir_list); <span class="comment">//called</span></span><br><span class="line">            <span class="keyword">if</span> (err) &#123;</span><br><span class="line">                    f2fs_put_page(page, <span class="number">1</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">	&#125;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><img src="C:\Users\rokid\AppData\Roaming\Typora\typora-user-images\image-20240228152822861.png" alt="image-20240228152822861"></p>
<h3 id="疑问2：ino-948少了recover-dentry流程？"><a href="#疑问2：ino-948少了recover-dentry流程？" class="headerlink" title="疑问2：ino&#x3D;948少了recover_dentry流程？"></a>疑问2：ino&#x3D;948少了recover_dentry流程？</h3><p><img src="C:\Users\rokid\AppData\Roaming\Typora\typora-user-images\image-20240228154123995.png" alt="image-20240228154123995"></p>
<h3 id="疑问3：尝试本地复现查看没加resize-f2fs的logcat日志中是否存在fsck的报错，如果有说明和resize-f2fs无关"><a href="#疑问3：尝试本地复现查看没加resize-f2fs的logcat日志中是否存在fsck的报错，如果有说明和resize-f2fs无关" class="headerlink" title="疑问3：尝试本地复现查看没加resize.f2fs的logcat日志中是否存在fsck的报错，如果有说明和resize.f2fs无关"></a>疑问3：尝试本地复现查看没加resize.f2fs的logcat日志中是否存在fsck的报错，如果有说明和resize.f2fs无关</h3><p>复现方法：并行执行增加文件脚本；同步进行删除操作，会看到IO error，后续设备红灯，抓取过dump信息后，设备进入recovery模式</p>
<p><img src="C:\Users\rokid\AppData\Roaming\Typora\typora-user-images\image-20240229154053896.png" alt="image-20240229154053896"></p>
<p><img src="C:\Users\rokid\AppData\Roaming\Typora\typora-user-images\image-20240229154100772.png" alt="image-20240229154100772"></p>
<p><img src="C:\Users\rokid\AppData\Roaming\Typora\typora-user-images\image-20240229154033817.png" alt="image-20240229154033817"></p>
<p><img src="C:\Users\rokid\AppData\Roaming\Typora\typora-user-images\image-20240229154439955.png" alt="image-20240229154439955"></p>
<p><img src="C:\Users\rokid\AppData\Roaming\Typora\typora-user-images\image-20240229154538694.png" alt="image-20240229154538694"></p>
<p><img src="C:\Users\rokid\AppData\Roaming\Typora\typora-user-images\image-20240229154513419.png" alt="image-20240229154513419"></p>
<h2 id="4-oops"><a href="#4-oops" class="headerlink" title="4.oops"></a>4.oops</h2><blockquote>
<p>[ 3827.193599] ————[ cut here ]————<br>[ 3827.193621] WARNING: CPU: 7 PID: 20047 at fs&#x2F;f2fs&#x2F;segment.c:2600 change_curseg+0x320&#x2F;0x388<br>[ 3827.193621] Modules linked in: wlan(O) machine_dlkm(O) wcd938x_slave_dlkm(O) wcd938x_dlkm(O) wcd9xxx_dlkm(O) mbhc_dlkm(O) tx_macro_dlkm(O) rx_macro_dlkm(O) va_macro_dlkm(O) wsa_macro_dlkm(O) swr_ctrl_dlkm(O) bolero_cdc_dlkm(O) wsa881x_dlkm(O) wcd_core_dlkm(O) stub_dlkm(O) hdmi_dlkm(O) swr_dlkm(O) pinctrl_lpi_dlkm(O) pinctrl_wcd_dlkm(O) usf_dlkm(O) native_dlkm(O) platform_dlkm(O) q6_dlkm(O) adsp_loader_dlkm(O) apr_dlkm(O) s<br>nd_event_dlkm(O) q6_notifier_dlkm(O) q6_pdr_dlkm(O) msm_11ad_proxy<br>[ 3827.193644] CPU: 7 PID: 20047 Comm: kworker&#x2F;u16:18 Tainted: G S      W  O      4.19.157-perf #1<br>[ 3827.193645] Hardware name: Qualcomm Technologies, Inc. kona-xr-overlay Standalone (DT)<br>[ 3827.193649] Workqueue: writeback wb_workfn (flush-252:6)<br>[ 3827.193651] pstate: 60c00005 (nZCv daif +PAN +UAO)<br>[ 3827.193652] pc : change_curseg+0x320&#x2F;0x388<br>[ 3827.193653] lr : change_curseg+0x318&#x2F;0x388<br>[ 3827.193653] sp : ffffff80120f3400<br>[ 3827.193654] x29: ffffff80120f3420 x28: 0000000000000002<br>[ 3827.193655] x27: 0000000000000002 x26: fffffffbc7368d54<br>[ 3827.193656] x25: 0000000000000340 x24: fffffffbc7368d10<br>[ 3827.193657] x23: fffffffbc52a8348 x22: fffffffbc7368cf0<br>[ 3827.193658] x21: 0000000000000001 x20: ffffffffffffff8b<br>[ 3827.193659] x19: fffffffbc72e6000 x18: 0000000000000034<br>[ 3827.193659] x17: ffffffae55466000 x16: 0000000000000050<br>[ 3827.193660] x15: 0000000000000050 x14: 0000000000000086<br>[ 3827.193661] x13: 0000000000000034 x12: 0000000000000000<br>[ 3827.193662] x11: 0000000000000000 x10: ffffffae54d99a58<br>[ 3827.193663] x9 : 15bbbd23809c8500 x8 : 15bbbd23809c8500<br>[ 3827.193664] x7 : 0000000000000000 x6 : fffffffbffacf240<br>[ 3827.193665] x5 : 0000000000000000 x4 : 0000000000000006<br>[ 3827.193666] x3 : 0000000000002d2d x2 : fffffffbffbe6c98<br>[ 3827.193667] x1 : fffffffbc72e6050 x0 : 0000000000000004<br>[ 3827.193668] Call trace:<br>[ 3827.193670]  change_curseg+0x320&#x2F;0x388<br>[ 3827.193672]  allocate_segment_by_default+0x17c&#x2F;0x1cc<br>[ 3827.193673]  f2fs_allocate_data_block+0x4d4&#x2F;0x770<br>[ 3827.193674]  do_write_page+0x80&#x2F;0x1a8<br>[ 3827.193675]  f2fs_outplace_write_data+0x58&#x2F;0x130<br>[ 3827.193676]  f2fs_do_write_data_page+0x3e4&#x2F;0x7d8<br>[ 3827.193677]  f2fs_write_single_data_page+0x4d8&#x2F;0x780<br>[ 3827.193678]  f2fs_write_data_pages+0x4d8&#x2F;0x700<br>[ 3827.193681]  do_writepages+0x64&#x2F;0x118<br>[ 3827.193682]  __writeback_single_inode+0xdc&#x2F;0x4b0<br>[ 3827.193683]  writeback_sb_inodes+0x468&#x2F;0x9e0<br>[ 3827.193684]  __writeback_inodes_wb+0xa4&#x2F;0x1b0<br>[ 3827.193685]  wb_writeback+0x270&#x2F;0x438<br>[ 3827.193686]  wb_workfn+0x3a8&#x2F;0x630<br>[ 3827.193689]  process_one_work+0x27c&#x2F;0x448<br>[ 3827.193690]  worker_thread+0x264&#x2F;0x4b0<br>[ 3827.193691]  kthread+0x144&#x2F;0x158<br>[ 3827.193693]  ret_from_fork+0x10&#x2F;0x1c<br>[ 3827.193694] —[ end trace e0724141b9490fbe ]—<br>[ 3827.193697] Unable to handle kernel paging request at virtual address ffffffffffffe2c0<br>[ 3827.202313] Mem abort info:<br>[ 3827.205220]   ESR &#x3D; 0x96000005<br>[ 3827.206126] init: Service ‘logcatd’ (pid 1702) exited with status 1<br>[ 3827.208419] init: Sending signal 9 to service ‘logcatd’ (pid 1702) process group…<br>[ 3827.208469]   Exception class &#x3D; DABT (current EL), IL &#x3D; 32 bits<br>[ 3827.208531] libprocessgroup: Successfully killed process cgroup uid 1036 pid 1702 in 0ms<br>[ 3827.214626]   SET &#x3D; 0, FnV &#x3D; 0<br>[ 3827.217814]   EA &#x3D; 0, S1PTW &#x3D; 0<br>[ 3827.220899] init: starting service ‘logcatd’…<br>[ 3827.221090] Data abort info:<br>[ 3827.224208]   ISV &#x3D; 0, ISS &#x3D; 0x00000005<br>[ 3827.228169]   CM &#x3D; 0, WnR &#x3D; 0<br>[ 3827.231219] swapper pgtable: 4k pages, 39-bit VAs, pgdp &#x3D; 000000004968e943<br>[ 3827.238314] [ffffffffffffe2c0] pgd&#x3D;0000000000000000, pud&#x3D;0000000000000000<br>[ 3827.245316] Internal error: Oops: 96000005 [#1] PREEMPT SMP<br>[ 3827.251036] Modules linked in: wlan(O) machine_dlkm(O) wcd938x_slave_dlkm(O) wcd938x_dlkm(O) wcd9xxx_dlkm(O) mbhc_dlkm(O) tx_macro_dlkm(O) rx_macro_dlkm(O) va_macro_dlkm(O) wsa_macro_dlkm(O) swr_ctrl_dlkm(O) bolero_cdc_dlkm(O) wsa881x_dlkm(O) wcd_core_dlkm(O) stub_dlkm(O) hdmi_dlkm(O) swr_dlkm(O) pinctrl_lpi_dlkm(O) pinctrl_wcd_dlkm(O) usf_dlkm(O) native_dlkm(O) platform_dlkm(O) q6_dlkm(O) adsp_loader_dlkm(O) apr_dlkm(O) snd_event_dlkm(O) q6_notifier_dlkm(O) q6_pdr_dlkm(O) msm_11ad_proxy<br>[ 3827.295302] Process kworker&#x2F;u16:18 (pid: 20047, stack limit &#x3D; 0x00000000ec2b678c)<br>[ 3827.302977] CPU: 7 PID: 20047 Comm: kworker&#x2F;u16:18 Tainted: G S      W  O      4.19.157-perf #1<br>[ 3827.311902] Hardware name: Qualcomm Technologies, Inc. kona-xr-overlay Standalone (DT)<br>[ 3827.320031] Workqueue: writeback wb_workfn (flush-252:6)<br>[ 3827.325484] pstate: 20c00005 (nzCv daif +PAN +UAO)<br>[ 3827.330411] pc : __memcpy+0x100&#x2F;0x180<br>[ 3827.334173] lr : change_curseg+0x298&#x2F;0x388<br>[ 3827.338377] sp : ffffff80120f3400<br>[ 3827.341783] x29: ffffff80120f3420 x28: 0000000000000002<br>[ 3827.347232] x27: 0000000000000002 x26: fffffffbc7368d54<br>[ 3827.352681] x25: 0000000000000340 x24: fffffffbc7368d10<br>[ 3827.358131] x23: fffffffbc52a8348 x22: fffffffbc7368cf0<br>[ 3827.363583] x21: 0000000000000001 x20: ffffffffffffff8b<br>[ 3827.369042] x19: fffffffbc72e6000 x18: 0000000000000034<br>[ 3827.374493] x17: ffffffae55466000 x16: 0000000000000050<br>[ 3827.379950] x15: 0000000000000050 x14: 0000000000000086<br>[ 3827.385400] x13: 0000000000000034 x12: 0000000000000000<br>[ 3827.390849] x11: 0000000000000000 x10: ffffffae54d99a58<br>[ 3827.396299] x9 : 15bbbd23809c8500 x8 : ffffffffffffe2c0<br>[ 3827.401747] x7 : 0000000000000000 x6 : fffffffbc8c2e000<br>[ 3827.407201] x5 : 0000000000000000 x4 : 0000000000000000<br>[ 3827.412651] x3 : 0000000000002d2d x2 : 0000000000000d80<br>[ 3827.418104] x1 : ffffffffffffe2c0 x0 : fffffffbc8c2e000<br>[ 3827.423554] Call trace:<br>[ 3827.426073]  __memcpy+0x100&#x2F;0x180<br>[ 3827.429481]  allocate_segment_by_default+0x17c&#x2F;0x1cc<br>[ 3827.434582]  f2fs_allocate_data_block+0x4d4&#x2F;0x770<br>[ 3827.439410]  do_write_page+0x80&#x2F;0x1a8<br>[ 3827.443173]  f2fs_outplace_write_data+0x58&#x2F;0x130<br>[ 3827.447920]  f2fs_do_write_data_page+0x3e4&#x2F;0x7d8<br>[ 3827.452666]  f2fs_write_single_data_page+0x4d8&#x2F;0x780<br>[ 3827.457769]  f2fs_write_data_pages+0x4d8&#x2F;0x700<br>[ 3827.462340]  do_writepages+0x64&#x2F;0x118<br>[ 3827.466104]  __writeback_single_inode+0xdc&#x2F;0x4b0<br>[ 3827.470851]  writeback_sb_inodes+0x468&#x2F;0x9e0<br>[ 3827.475239]  __writeback_inodes_wb+0xa4&#x2F;0x1b0<br>[ 3827.479715]  wb_writeback+0x270&#x2F;0x438<br>[ 3827.483477]  wb_workfn+0x3a8&#x2F;0x630<br>[ 3827.486972]  process_one_work+0x27c&#x2F;0x448<br>[ 3827.564345]  worker_thread+0x264&#x2F;0x4b0<br>[ 3827.568197]  kthread+0x144&#x2F;0x158<br>[ 3827.571515]  ret_from_fork+0x10&#x2F;0x1c</p>
</blockquote>
<h3 id="4-1-WARN-ON打印"><a href="#4-1-WARN-ON打印" class="headerlink" title="4.1 WARN_ON打印"></a>4.1 WARN_ON打印</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[ 3827.193621] WARNING: CPU: 7 PID: 20047 at fs/f2fs/segment.c:2600 change_curseg+0x320/0x388</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\rokid\AppData\Roaming\Typora\typora-user-images\image-20240229162039839.png" alt="image-20240229162039839"></p>
<p><img src="C:\Users\rokid\AppData\Roaming\Typora\typora-user-images\image-20240229162103126.png" alt="image-20240229162103126"></p>
<p><img src="C:\Users\rokid\AppData\Roaming\Typora\typora-user-images\image-20240229162321094.png" alt="image-20240229162321094"></p>
<h3 id="4-2-Unable-to-handle-kernel-paging-request-at-virtual-address"><a href="#4-2-Unable-to-handle-kernel-paging-request-at-virtual-address" class="headerlink" title="4.2 Unable to handle kernel paging request at virtual address"></a>4.2 Unable to handle kernel paging request at virtual address</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[ 3827.330411] pc : __memcpy+0x100/0x180</span><br><span class="line">[ 3827.334173] lr : change_curseg+0x298/0x388</span><br><span class="line">[ 3827.338377] sp : ffffff80120f3400</span><br><span class="line">[ 3827.341783] x29: ffffff80120f3420 x28: 0000000000000002 </span><br><span class="line">[ 3827.347232] x27: 0000000000000002 x26: fffffffbc7368d54 </span><br><span class="line">[ 3827.352681] x25: 0000000000000340 x24: fffffffbc7368d10 </span><br><span class="line">[ 3827.358131] x23: fffffffbc52a8348 x22: fffffffbc7368cf0 </span><br><span class="line">[ 3827.363583] x21: 0000000000000001 x20: ffffffffffffff8b </span><br><span class="line">[ 3827.369042] x19: fffffffbc72e6000 x18: 0000000000000034 </span><br><span class="line">[ 3827.374493] x17: ffffffae55466000 x16: 0000000000000050 </span><br><span class="line">[ 3827.379950] x15: 0000000000000050 x14: 0000000000000086 </span><br><span class="line">[ 3827.385400] x13: 0000000000000034 x12: 0000000000000000 </span><br><span class="line">[ 3827.390849] x11: 0000000000000000 x10: ffffffae54d99a58 </span><br><span class="line">[ 3827.396299] x9 : 15bbbd23809c8500 x8 : ffffffffffffe2c0 </span><br><span class="line">[ 3827.401747] x7 : 0000000000000000 x6 : fffffffbc8c2e000 </span><br><span class="line">[ 3827.407201] x5 : 0000000000000000 x4 : 0000000000000000 </span><br><span class="line">[ 3827.412651] x3 : 0000000000002d2d x2 : 0000000000000d80 </span><br><span class="line">[ 3827.418104] x1 : ffffffffffffe2c0 x0 : fffffffbc8c2e000 </span><br><span class="line">[ 3827.423554] Call trace:</span><br><span class="line">[ 3827.426073]  __memcpy+0x100/0x180</span><br><span class="line">[ 3827.429481]  allocate_segment_by_default+0x17c/0x1cc</span><br><span class="line">[ 3827.434582]  f2fs_allocate_data_block+0x4d4/0x770</span><br><span class="line">[ 3827.439410]  do_write_page+0x80/0x1a8</span><br><span class="line">[ 3827.443173]  f2fs_outplace_write_data+0x58/0x130</span><br><span class="line">[ 3827.447920]  f2fs_do_write_data_page+0x3e4/0x7d8</span><br><span class="line">[ 3827.452666]  f2fs_write_single_data_page+0x4d8/0x780</span><br><span class="line">[ 3827.457769]  f2fs_write_data_pages+0x4d8/0x700</span><br><span class="line">[ 3827.462340]  do_writepages+0x64/0x118</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">crash&gt; </span><span class="language-bash">dis -l __memcpy+0x100</span></span><br><span class="line">/data/jenkins/workspace/StationPro_new/sxr2130p_repo/emdoor/LINUX/android/kernel/msm-4.19/arch/arm64/lib/copy_template.S: 167</span><br><span class="line">0xffffffae53e6bb40 &lt;memcpy+256&gt;:        ldp     x7, x8, [x1], #16</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">crash&gt; </span><span class="language-bash">dis -l allocate_segment_by_default+0x17c</span></span><br><span class="line">/data/jenkins/workspace/StationPro_new/sxr2130p_repo/emdoor/LINUX/android/kernel/msm-4.19/fs/f2fs/segment.c: 2677</span><br><span class="line">0xffffffae52cd6514 &lt;allocate_segment_by_default+380&gt;:   b       0xffffffae52cd6530 &lt;allocate_segment_by_default+408&gt;</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\rokid\AppData\Roaming\Typora\typora-user-images\image-20240229155152870.png" alt="image-20240229155152870"></p>
<p><img src="C:\Users\rokid\AppData\Roaming\Typora\typora-user-images\image-20240229155114373.png" alt="image-20240229155114373"></p>
<h4 id="反汇编"><a href="#反汇编" class="headerlink" title="反汇编"></a>反汇编</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/data/jenkins/workspace/StationPro_new/sxr2130p_repo/emdoor/LINUX/android/kernel/msm-4.19/fs/f2fs/segment.c: 2602</span><br><span class="line">0xffffffae52cceac4 &lt;change_curseg+644&gt;: ldr     x0, [x24]</span><br><span class="line">/data/jenkins/workspace/StationPro_new/sxr2130p_repo/emdoor/LINUX/android/kernel/msm-4.19/include/linux/mm.h: 1246</span><br><span class="line">0xffffffae52cceac8 &lt;change_curseg+648&gt;: lsl     x8, x20, #6</span><br><span class="line">0xffffffae52cceacc &lt;change_curseg+652&gt;: orr     x1, x8, #0xffffffc000000000</span><br><span class="line">/data/jenkins/workspace/StationPro_new/sxr2130p_repo/emdoor/LINUX/android/kernel/msm-4.19/fs/f2fs/segment.c: 2602</span><br><span class="line">0xffffffae52ccead0 &lt;change_curseg+656&gt;: mov     w2, #0xe00                      // #3584</span><br><span class="line">0xffffffae52ccead4 &lt;change_curseg+660&gt;: bl      0xffffffae53e6ba40 &lt;__memcpy&gt;</span><br></pre></td></tr></table></figure>



<h4 id="memcpy"><a href="#memcpy" class="headerlink" title="memcpy"></a>memcpy</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">crash&gt; dis -l __memcpy+0x100</span><br><span class="line">/data/jenkins/workspace/StationPro_new/sxr2130p_repo/emdoor/LINUX/android/kernel/msm-4.19/arch/arm64/lib/copy_template.S: 167</span><br><span class="line">0xffffffae53e6bb40 &lt;memcpy+256&gt;:        ldp     x7, x8, [x1], #16</span><br></pre></td></tr></table></figure>

<p>注：</p>
<p>LDP指令从目标内存地址中加载数据，并将其存储到和或和寄存器中。加载的数据可以是32位或64位，具体取决于使用的寄存器。<br>以下示例演示了如何使用LDP指令从内存中加载两个通用寄存器的值：</p>
<blockquote>
<p>LDP X0, X1, [X2]		    从[X2]地址中加载值到X0和X1寄存器<br>LDP W3, W4, [SP, #16]	从[SP+16]地址中加载值到W3和W4寄存器</p>
</blockquote>
<p>&#x3D;&#x3D;&gt; </p>
<p>x7 &#x3D; x1+16 </p>
<p>x8 &#x3D; x1+16</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Copy a buffer from src to dest (alignment handled by the hardware)</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Parameters:</span></span><br><span class="line"><span class="comment"> *      x0 - dest</span></span><br><span class="line"><span class="comment"> *      x1 - src</span></span><br><span class="line"><span class="comment"> *      x2 - n</span></span><br><span class="line"><span class="comment"> * Returns:</span></span><br><span class="line"><span class="comment"> *      x0 - dest</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">dstin   .req    x0</span><br><span class="line">src     .req    x1</span><br><span class="line">count   .req    x2</span><br><span class="line">tmp1    .req    x3</span><br><span class="line">tmp1w   .req    w3</span><br><span class="line">tmp2    .req    x4</span><br><span class="line">tmp2w   .req    w4</span><br><span class="line">dst     .req    x6</span><br><span class="line"></span><br><span class="line">A_l     .req    x7</span><br><span class="line">A_h     .req    x8</span><br><span class="line">B_l     .req    x9</span><br><span class="line">B_h     .req    x10</span><br><span class="line">C_l     .req    x11</span><br><span class="line">C_h     .req    x12</span><br><span class="line">D_l     .req    x13</span><br><span class="line">D_h     .req    x14</span><br><span class="line"></span><br><span class="line">b.eq    .LSrcAligned</span><br><span class="line">    </span><br><span class="line">.LSrcAligned:</span><br><span class="line">        cmp     count, #<span class="number">64</span></span><br><span class="line">        b.ge    .Lcpy_over64</span><br><span class="line">            </span><br><span class="line">.Lcpy_over64:</span><br><span class="line">        subs    count, count, #<span class="number">128</span></span><br><span class="line">        b.ge    .Lcpy_body_large</span><br><span class="line">        </span><br><span class="line">.Lcpy_body_large:</span><br><span class="line">        <span class="comment">/* pre-get 64 bytes data. */</span></span><br><span class="line">        ldp1    A_l, A_h, src, #<span class="number">16</span> <span class="comment">//called</span></span><br></pre></td></tr></table></figure>



<h4 id="x1寄存器的赋值情况，截断到memcpy"><a href="#x1寄存器的赋值情况，截断到memcpy" class="headerlink" title="x1寄存器的赋值情况，截断到memcpy"></a>x1寄存器的赋值情况，截断到memcpy</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">0xffffffae52cce894 &lt;change_curseg+84&gt;:  ldr     x1, [x24, #32]!</span><br><span class="line">0xffffffae52cce8dc &lt;change_curseg+156&gt;: add     x1, x8, x25, lsl #3</span><br><span class="line">0xffffffae52cce8e0 &lt;change_curseg+160&gt;: ldr     x8, [x1]</span><br><span class="line">0xffffffae52cce8f8 &lt;change_curseg+184&gt;: ldsetal x0, x0, [x1]</span><br><span class="line">0xffffffae52cce91c &lt;change_curseg+220&gt;: add     x1, x9, w11, uxtw #3</span><br><span class="line">0xffffffae52cce924 &lt;change_curseg+228&gt;: ldr     x8, [x1]</span><br><span class="line">0xffffffae52cce944 &lt;change_curseg+260&gt;: ldsetal x0, x0, [x1]</span><br><span class="line">0xffffffae52cce984 &lt;change_curseg+324&gt;: add     x1, x9, x25, lsl #3</span><br><span class="line">0xffffffae52cce988 &lt;change_curseg+328&gt;: ldr     x9, [x1]</span><br><span class="line">0xffffffae52cce9a0 &lt;change_curseg+352&gt;: ldclral x0, x0, [x1]</span><br><span class="line">0xffffffae52cceacc &lt;change_curseg+652&gt;: orr     x1, x8, #0xffffffc000000000</span><br></pre></td></tr></table></figure>





<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[ <span class="number">3827.412651</span>] x3 : <span class="number">0000000000002</span>d2d x2 : <span class="number">0000000000000</span>d80 </span><br><span class="line">[ <span class="number">3827.418104</span>] x1 : ffffffffffffe2c0 x0 : fffffffbc8c2e000</span><br><span class="line"></span><br><span class="line"><span class="title function_">memcpy</span><span class="params">(curseg-&gt;sum_blk, sum_node, SUM_ENTRY_SIZE)</span>;</span><br><span class="line"></span><br><span class="line">curseg-&gt;sum_blk -&gt; x0</span><br><span class="line">sum_node -&gt; x1</span><br><span class="line">SUM_ENTRY_SIZE -&gt; x2</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ENTRIES_IN_SUM		512</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	SUMMARY_SIZE		(7)	<span class="comment">/* sizeof(struct summary) */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	SUM_FOOTER_SIZE		(5)	<span class="comment">/* sizeof(struct summary_footer) */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SUM_ENTRY_SIZE		(SUMMARY_SIZE * ENTRIES_IN_SUM)</span></span><br></pre></td></tr></table></figure>

<p>x1地址有问题，即sum_node地址有问题，来自于sum_page</p>
<h3 id="猜测：f2fs一致性损坏，当回写时触发oops"><a href="#猜测：f2fs一致性损坏，当回写时触发oops" class="headerlink" title="猜测：f2fs一致性损坏，当回写时触发oops"></a>猜测：f2fs一致性损坏，当回写时触发oops</h3><h3 id="4-3-change-curseg"><a href="#4-3-change-curseg" class="headerlink" title="4.3 change_curseg"></a>4.3 change_curseg</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[ 3827.193599] ------------[ cut here ]------------</span><br><span class="line">[ 3827.193621] WARNING: CPU: 7 PID: 20047 at fs/f2fs/segment.c:2600 change_curseg+0x320/0x388</span><br><span class="line">[ 3827.193621] Modules linked in: wlan(O) machine_dlkm(O) wcd938x_slave_dlkm(O) wcd938x_dlkm(O) wcd9xxx_dlkm(O) mbhc_dlkm(O) tx_macro_dlkm(O) rx_macro_dlkm(O) va_macro_dlkm(O) wsa_macro_dlkm(O) swr_ctrl_dlkm(O) bolero_cdc_dlkm(O) wsa881x_dlkm(O) wcd_core_dlkm(O) stub_dlkm(O) hdmi_dlkm(O) swr_dlkm(O) pinctrl_lpi_dlkm(O) pinctrl_wcd_dlkm(O) usf_dlkm(O) native_dlkm(O) platform_dlkm(O) q6_dlkm(O) adsp_loader_dlkm(O) apr_dlkm(O) s</span><br><span class="line">nd_event_dlkm(O) q6_notifier_dlkm(O) q6_pdr_dlkm(O) msm_11ad_proxy</span><br><span class="line">[ 3827.193644] CPU: 7 PID: 20047 Comm: kworker/u16:18 Tainted: G S      W  O      4.19.157-perf #1</span><br><span class="line">[ 3827.193645] Hardware name: Qualcomm Technologies, Inc. kona-xr-overlay Standalone (DT)</span><br><span class="line">[ 3827.193649] Workqueue: writeback wb_workfn (flush-252:6)</span><br><span class="line">[ 3827.193651] pstate: 60c00005 (nZCv daif +PAN +UAO)</span><br><span class="line">[ 3827.193652] pc : change_curseg+0x320/0x388</span><br><span class="line">[ 3827.193653] lr : change_curseg+0x318/0x388</span><br><span class="line">[ 3827.193653] sp : ffffff80120f3400</span><br><span class="line">[ 3827.193654] x29: ffffff80120f3420 x28: 0000000000000002 </span><br><span class="line">[ 3827.193655] x27: 0000000000000002 x26: fffffffbc7368d54 </span><br><span class="line">[ 3827.193656] x25: 0000000000000340 x24: fffffffbc7368d10 </span><br><span class="line">[ 3827.193657] x23: fffffffbc52a8348 x22: fffffffbc7368cf0 </span><br><span class="line">[ 3827.193658] x21: 0000000000000001 x20: ffffffffffffff8b </span><br><span class="line">[ 3827.193659] x19: fffffffbc72e6000 x18: 0000000000000034 </span><br><span class="line">[ 3827.193659] x17: ffffffae55466000 x16: 0000000000000050 </span><br><span class="line">[ 3827.193660] x15: 0000000000000050 x14: 0000000000000086 </span><br><span class="line">[ 3827.193661] x13: 0000000000000034 x12: 0000000000000000 </span><br><span class="line">[ 3827.193662] x11: 0000000000000000 x10: ffffffae54d99a58 </span><br><span class="line">[ 3827.193663] x9 : 15bbbd23809c8500 x8 : 15bbbd23809c8500 </span><br><span class="line">[ 3827.193664] x7 : 0000000000000000 x6 : fffffffbffacf240 </span><br><span class="line">[ 3827.193665] x5 : 0000000000000000 x4 : 0000000000000006 </span><br><span class="line">[ 3827.193666] x3 : 0000000000002d2d x2 : fffffffbffbe6c98 </span><br><span class="line">[ 3827.193667] x1 : fffffffbc72e6050 x0 : 0000000000000004 </span><br><span class="line">[ 3827.193668] Call trace:</span><br><span class="line">[ 3827.193670]  change_curseg+0x320/0x388</span><br><span class="line">[ 3827.193672]  allocate_segment_by_default+0x17c/0x1cc</span><br></pre></td></tr></table></figure>

<p>在memcpy前执行了change_curseg</p>
<p>当前调用栈在change_curseg+0x320</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">crash&gt; </span><span class="language-bash">dis -l change_curseg+0x320</span></span><br><span class="line">/data/jenkins/workspace/StationPro_new/sxr2130p_repo/emdoor/LINUX/android/kernel/msm-4.19/fs/f2fs/segment.c: 2600</span><br><span class="line">0xffffffae52cceb60 &lt;change_curseg+800&gt;: brk     #0x800</span><br><span class="line"></span><br><span class="line">f2fs_bug_on(sbi, IS_ERR(sum_page));</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">define f2fs_bug_on(sbi, condition)					\</span></span><br><span class="line"><span class="language-bash">	<span class="keyword">do</span> &#123;								\</span></span><br><span class="line"><span class="language-bash">		<span class="keyword">if</span> (unlikely(condition)) &#123;				\</span></span><br><span class="line"><span class="language-bash">			WARN_ON(1);					\</span></span><br><span class="line"><span class="language-bash">			set_sbi_flag(sbi, SBI_NEED_FSCK);		\</span></span><br><span class="line"><span class="language-bash">		&#125;							\</span></span><br><span class="line"><span class="language-bash">	&#125; <span class="keyword">while</span> (0)</span></span><br><span class="line"><span class="meta prompt_">	</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">整合一下</span></span><br><span class="line">/data/jenkins/workspace/StationPro_new/sxr2130p_repo/emdoor/LINUX/android/kernel/msm-4.19/fs/f2fs/segment.c: 2600</span><br><span class="line">0xffffffae52cceabc &lt;change_curseg+636&gt;: cmn     x0, #0xfff -&gt; IS_ERR(sum_page)</span><br><span class="line">0xffffffae52cceac0 &lt;change_curseg+640&gt;: b.cs    0xffffffae52cceb4c &lt;change_curseg+780&gt;  // b.hs, b.nlast</span><br><span class="line">//b.hs指令是判断是否无符号小于</span><br><span class="line">/data/jenkins/workspace/StationPro_new/sxr2130p_repo/emdoor/LINUX/android/kernel/msm-4.19/fs/f2fs/segment.c: 2600</span><br><span class="line">0xffffffae52cceb4c &lt;change_curseg+780&gt;: adrp    x0, 0xffffffae54712000</span><br><span class="line">0xffffffae52cceb50 &lt;change_curseg+784&gt;: add     x0, x0, #0xe0 </span><br><span class="line">0xffffffae52cceb54 &lt;change_curseg+788&gt;: bl      0xffffffae529580b8 &lt;printk&gt;</span><br><span class="line">/data/jenkins/workspace/StationPro_new/sxr2130p_repo/emdoor/LINUX/android/kernel/msm-4.19/fs/f2fs/segment.c: 2600</span><br><span class="line">0xffffffae52cceb60 &lt;change_curseg+800&gt;: brk     #0x800</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\rokid\AppData\Roaming\Typora\typora-user-images\image-20240229205911145.png" alt="image-20240229205911145"></p>
<h2 id="5-ARM虚拟地址空间布局"><a href="#5-ARM虚拟地址空间布局" class="headerlink" title="5.ARM虚拟地址空间布局"></a>5.ARM虚拟地址空间布局</h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/longwang155069/article/details/105381709">根据crash学习ARM64虚拟地址空间布局_address between user and kernel address ranges-CSDN博客</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[ 3827.231219] swapper pgtable: 4k pages, 39-bit VAs, pgdp = 000000004968e943</span><br><span class="line">[ 3827.238314] [ffffffffffffe2c0] pgd=0000000000000000, pud=0000000000000000</span><br><span class="line">[ 3827.245316] Internal error: Oops: 96000005 [#1] PREEMPT SMP</span><br></pre></td></tr></table></figure>



<h2 id="6-f2fs不一致"><a href="#6-f2fs不一致" class="headerlink" title="6.f2fs不一致"></a>6.f2fs不一致</h2><p>F2FS-fs (dm-6): invalid blkaddr: 116238, type: 9, run fsck to fix.</p>
<p>F2FS-fs (dm-6): inconsistent node block, nid:1393, node_footer[nid:0,ino:0,ofs:0,cpver:0,blkaddr:0]</p>
<h3 id="6-1-invalid-blkaddr"><a href="#6-1-invalid-blkaddr" class="headerlink" title="6.1 invalid blkaddr"></a>6.1 invalid blkaddr</h3><h4 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h4><blockquote>
<p>[ 3776.954849] WARNING: CPU: 6 PID: 1443 at fs&#x2F;f2fs&#x2F;f2fs.h:3109 f2fs_submit_page_write+0x398&#x2F;0x820<br>[ 3776.954850] Modules linked in: wlan(O) machine_dlkm(O) wcd938x_slave_dlkm(O) wcd938x_dlkm(O) wcd9xxx_dlkm(O) mbhc_dlkm(O) tx_macro_dlkm(O) rx_macro_dlkm(O) va_macro_dlkm(O) wsa_macro_dlkm(O) swr_ctrl_dlkm(O) bolero_cdc_dlkm(O) wsa881x_dlkm(O) wcd_core_dlkm(O) stub_dlkm(O) hdmi_dlkm(O) swr_dlkm(O) pinctrl_lpi_dlkm(O) pinctrl_wcd_dlkm(O) usf_dlkm(O) native_dlkm(O) platform_dlkm(O) q6_dlkm(O) adsp_loader_dlkm(O) apr_dlkm(O) snd_event_dlkm(O) q6_notifier_dlkm(O) q6_pdr_dlkm(O) msm_11ad_proxy<br>[ 3776.954858] CPU: 6 PID: 1443 Comm: watchdog Tainted: G S      W  O      4.19.157-perf #1<br>[ 3776.954858] Hardware name: Qualcomm Technologies, Inc. kona-xr-overlay Standalone (DT)<br>[ 3776.954859] pstate: 60400005 (nZCv daif +PAN -UAO)<br>[ 3776.954860] pc : f2fs_submit_page_write+0x398&#x2F;0x820<br>[ 3776.954860] lr : f2fs_submit_page_write+0x390&#x2F;0x820<br>[ 3776.954861] sp : ffffff8009b93630<br>[ 3776.954861] x29: ffffff8009b93670 x28: 000000000001c602<br>[ 3776.954862] x27: fffffffbc72e6000 x26: fffffffbc72e6000<br>[ 3776.954863] x25: 0000000000000009 x24: 00000000ffffffff<br>[ 3776.954864] x23: fffffffbcadfd018 x22: 0000000000000088<br>[ 3776.954864] x21: ffffff8009b936d0 x20: fffffffbcadfd008<br>[ 3776.954865] x19: fffffffbcadfd000 x18: 0000000000000034<br>[ 3776.954866] x17: ffffffae55466000 x16: 00000000000000c0<br>[ 3776.954867] x15: 00000000000000c0 x14: 0000000000000086<br>[ 3776.954867] x13: 0000000000000034 x12: 0000000000000000<br>[ 3776.954868] x11: 0000000000000000 x10: 0000000000000007<br>[ 3776.954869] x9 : 15bbbd23809c8500 x8 : 15bbbd23809c8500<br>[ 3776.954870] x7 : 0000000000000000 x6 : fffffffbffa845dc<br>[ 3776.954871] x5 : 0000000000000000 x4 : 0000000000000006<br>[ 3776.954871] x3 : 0000000000002d2d x2 : 0000000000000007<br>[ 3776.954872] x1 : fffffffbc72e6050 x0 : 0000000000000004<br>[ 3776.954873] Call trace:<br>[ 3776.954874]  f2fs_submit_page_write+0x398&#x2F;0x820<br>[ 3776.954875]  f2fs_do_write_meta_page+0xd0&#x2F;0x200<br>[ 3776.954876]  __f2fs_write_meta_page+0x13c&#x2F;0x1c0<br>[ 3776.954877]  f2fs_sync_meta_pages+0x1a0&#x2F;0x330<br>[ 3776.954879]  f2fs_write_checkpoint+0x5b0&#x2F;0x1598<br>[ 3776.954880]  f2fs_sync_fs+0x124&#x2F;0x180<br>[ 3776.954881]  f2fs_do_sync_file+0x57c&#x2F;0xa18<br>[ 3776.954882]  f2fs_sync_file+0x54&#x2F;0x70<br>[ 3776.954883]  __arm64_sys_fdatasync+0x4c&#x2F;0x98<br>[ 3776.954885]  el0_svc_common+0x9c&#x2F;0x168<br>[ 3776.954886]  el0_svc_handler+0x6c&#x2F;0x88<br>[ 3776.954887]  el0_svc+0x8&#x2F;0x380<br>[ 3776.954887] —[ end trace e0724141b9490f67 ]—<br>[ 3776.954897] F2FS-fs (dm-6): invalid blkaddr: 116227, type: 9, run fsck to fix.</p>
</blockquote>
<h4 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">f2fs_submit_page_write(<span class="keyword">struct</span> f2fs_io_info *fio)</span><br><span class="line">	verify_fio_blkaddr(<span class="keyword">struct</span> f2fs_io_info *fio)</span><br><span class="line">		verify_blkaddr(sbi, fio-&gt;old_blkaddr, __is_meta_io(fio) ? META_GENERIC : DATA_GENERIC);</span><br><span class="line">			!f2fs_is_valid_blkaddr(sbi, blkaddr, type) <span class="comment">//return 0</span></span><br><span class="line">    			<span class="comment">//invalid blkaddr</span></span><br></pre></td></tr></table></figure>

<p>因为type是9，所以走META_GENERIC分支</p>
<p><img src="C:\Users\rokid\AppData\Roaming\Typora\typora-user-images\image-20240301111114033.png" alt="image-20240301111114033"></p>
<p><img src="C:\Users\rokid\AppData\Roaming\Typora\typora-user-images\image-20240301111104791.png" alt="image-20240301111104791"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> MAIN_BLKADDR(sbi)						\</span></span><br><span class="line"><span class="meta">	(SM_I(sbi) ? SM_I(sbi)-&gt;main_blkaddr : 				\</span></span><br><span class="line"><span class="meta">		le32_to_cpu(F2FS_RAW_SUPER(sbi)-&gt;main_blkaddr))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SEG0_BLKADDR(sbi)						\</span></span><br><span class="line"><span class="meta">	(SM_I(sbi) ? SM_I(sbi)-&gt;seg0_blkaddr : 				\</span></span><br><span class="line"><span class="meta">		le32_to_cpu(F2FS_RAW_SUPER(sbi)-&gt;segment0_blkaddr))</span></span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/RiweiPan/F2FS-NOTES/raw/master/img/F2FS-Layout/sb_layout2.png" alt="sb_layout"></p>
<p>f2fs_sm_info是内存中管理segment的总体结构，主要是为了方便查找可用的block以及高效执行gc、discard等操作。</p>
<ul>
<li>seg0_blkaddr：与SuperBlock的介绍一样，是第一个segment的地址。</li>
<li>main_blkaddr：Main Area的开始地址。</li>
</ul>
<p>blkaddr由fio-&gt;old_blkaddr赋值</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">f2fs_do_write_meta_page</span><span class="params">(<span class="keyword">struct</span> f2fs_sb_info *sbi, <span class="keyword">struct</span> page *page,</span></span><br><span class="line"><span class="params">					<span class="keyword">enum</span> iostat_type io_type)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">f2fs_io_info</span> <span class="title">fio</span> =</span> &#123;</span><br><span class="line">		.sbi = sbi,</span><br><span class="line">		.type = META,</span><br><span class="line">		.temp = HOT,</span><br><span class="line">		.op = REQ_OP_WRITE,</span><br><span class="line">		.op_flags = REQ_SYNC | REQ_META | REQ_PRIO,</span><br><span class="line">		.old_blkaddr = page-&gt;index, <span class="comment">//！！！</span></span><br><span class="line">		.new_blkaddr = page-&gt;index,</span><br><span class="line">		.page = page,</span><br><span class="line">		.encrypted_page = <span class="literal">NULL</span>,</span><br><span class="line">		.in_list = <span class="literal">false</span>,</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (unlikely(page-&gt;index &gt;= MAIN_BLKADDR(sbi)))</span><br><span class="line">		fio.op_flags &amp;= ~REQ_META;</span><br><span class="line"></span><br><span class="line">	set_page_writeback(page);</span><br><span class="line">	ClearPageError(page);</span><br><span class="line">	f2fs_submit_page_write(&amp;fio);<span class="comment">//called</span></span><br><span class="line"></span><br><span class="line">	stat_inc_meta_count(sbi, page-&gt;index);</span><br><span class="line">	f2fs_update_iostat(sbi, io_type, F2FS_BLKSIZE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>fio-&gt;old_blkaddr来自于page-&gt;index</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">f2fs_sync_meta_pages</span><br><span class="line">	__f2fs_write_meta_page(page)</span><br><span class="line">		f2fs_do_write_meta_page(sbi,page)</span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">f2fs_sync_meta_pages</span><br><span class="line">	<span class="title function_">pagevec_lookup_tag</span><span class="params">(&amp;pvec, mapping, &amp;index, PAGECACHE_TAG_DIRTY)</span></span><br><span class="line">    <span class="keyword">struct</span> page *page = pvec.pages[i];</span><br><span class="line">	__f2fs_write_meta_page(page, &amp;wbc, io_type)</span><br></pre></td></tr></table></figure>

<p>page来自于pvec</p>
<h4 id="pvec参数传递流程"><a href="#pvec参数传递流程" class="headerlink" title="pvec参数传递流程"></a>pvec参数传递流程</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pagevec_lookup_tag(&amp;pvec, mapping, &amp;index, PAGECACHE_TAG_DIRTY)</span><br><span class="line">	pagevec_lookup_range_tag(pvec, mapping, index, (<span class="type">pgoff_t</span>)<span class="number">-1</span>, tag)</span><br><span class="line">		find_get_pages_range_tag(mapping, index, end, tag, PAGEVEC_SIZE, pvec-&gt;pages)</span><br><span class="line">    		radix_tree_for_each_tagged(slot, &amp;mapping-&gt;i_pages, &amp;iter, *index, tag)&#123;</span><br><span class="line">    			page = radix_tree_deref_slot(slot) <span class="comment">//called</span></span><br><span class="line">			&#125;</span><br></pre></td></tr></table></figure>

<p>page是在指定范围地址空间搜索得到</p>
<h4 id="f2fs-sm-info"><a href="#f2fs-sm-info" class="headerlink" title="f2fs_sm_info"></a>f2fs_sm_info</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="keyword">struct</span> f2fs_sb_info *<span class="title function_">F2FS_SB</span><span class="params">(<span class="keyword">struct</span> super_block *sb)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">return</span> sb-&gt;s_fs_info;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="keyword">struct</span> f2fs_sm_info *<span class="title function_">SM_I</span><span class="params">(<span class="keyword">struct</span> f2fs_sb_info *sbi)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">struct</span> f2fs_sm_info *)(sbi-&gt;sm_info);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">crash&gt; super_block -xo | grep s_fs_info</span><br><span class="line">  [<span class="number">0x440</span>] <span class="type">void</span> *s_fs_info;</span><br><span class="line"></span><br><span class="line">fffffffa5da1f000 + <span class="number">0x440</span> = fffffffa5da1f440</span><br><span class="line"></span><br><span class="line">crash&gt; rd fffffffa5da1f440</span><br><span class="line">fffffffa5da1f440:  fffffffbc72e6000                    .`......  </span><br><span class="line">    </span><br><span class="line">f2fs_sb_info fffffffbc72e6000</span><br><span class="line">    </span><br><span class="line">crash&gt; f2fs_sb_info -xo | grep sm_info</span><br><span class="line">   [<span class="number">0x88</span>] <span class="keyword">struct</span> f2fs_sm_info *sm_info;</span><br><span class="line"></span><br><span class="line">fffffffbc72e6000 + <span class="number">0x88</span> = fffffffbc72e6088</span><br><span class="line">    </span><br><span class="line">crash&gt; rd fffffffbc72e6088</span><br><span class="line">fffffffbc72e6088:  fffffffbc8ce1600                    ........</span><br><span class="line">    </span><br><span class="line">f2fs_sm_info fffffffbc8ce1600</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\rokid\AppData\Roaming\Typora\typora-user-images\image-20240301160740133.png" alt="image-20240301160740133"></p>
<h3 id="6-2-inconsistent-node-block"><a href="#6-2-inconsistent-node-block" class="headerlink" title="6.2 inconsistent node block"></a>6.2 inconsistent node block</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">f2fs_get_node_page</span><br><span class="line">	__get_node_page</span><br><span class="line">		nid != nid_of_node(page)</span><br><span class="line">			<span class="comment">//inconsistent node block</span></span><br></pre></td></tr></table></figure>



<p>没有任何操作 设备猛刷但是没有oops</p>
<p><img src="C:\Users\rokid\AppData\Roaming\Typora\typora-user-images\image-20240301162357465.png" alt="image-20240301162357465"></p>
<p>写裸盘操作</p>
<p><img src="C:\Users\rokid\AppData\Roaming\Typora\typora-user-images\image-20240304101717471.png" alt="image-20240304101717471"></p>
<p><img src="C:\Users\rokid\AppData\Roaming\Typora\typora-user-images\image-20240304102521981.png" alt="image-20240304102521981"></p>
<p><img src="C:\Users\rokid\AppData\Roaming\Typora\typora-user-images\image-20240304105218169.png" alt="image-20240304105218169"></p>
<p><img src="C:\Users\rokid\AppData\Roaming\Typora\typora-user-images\image-20240304105613917.png" alt="image-20240304105613917"></p>
<h3 id="另一种报错"><a href="#另一种报错" class="headerlink" title="另一种报错"></a>另一种报错</h3><p><img src="C:\Users\rokid\AppData\Roaming\Typora\typora-user-images\image-20240304112839926.png" alt="image-20240304112839926"></p>
<h3 id="疑问4：直接对裸设备按照物理地址写操作，破坏了关键文件的node数据区域；那么为啥增删文件会复现"><a href="#疑问4：直接对裸设备按照物理地址写操作，破坏了关键文件的node数据区域；那么为啥增删文件会复现" class="headerlink" title="疑问4：直接对裸设备按照物理地址写操作，破坏了关键文件的node数据区域；那么为啥增删文件会复现"></a>疑问4：直接对裸设备按照物理地址写操作，破坏了关键文件的node数据区域；那么为啥增删文件会复现</h3><h2 id="7-查看data分区"><a href="#7-查看data分区" class="headerlink" title="7.查看data分区"></a>7.查看data分区</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">super_block fffffffa5da1f000</span><br><span class="line"></span><br><span class="line">super_block + 0x440 = f2fs_sb_info* fffffffa5da1f440</span><br><span class="line"></span><br><span class="line">rd fffffffa5da1f440 -&gt; f2fs_sb_info fffffffbc72e6000</span><br><span class="line"></span><br><span class="line">rd fffffffbc72e6010 -&gt; f2fs_super_block fffffffbc72e0000</span><br></pre></td></tr></table></figure>



<p><img src="C:\Users\rokid\AppData\Roaming\Typora\typora-user-images\image-20240229221413574.png" alt="image-20240229221413574"></p>
<p>53279*2M &#x2F; 1024 （G） &#x3D; 104G</p>
<p>也差不多满了</p>
<h2 id="8-dump-f2fs"><a href="#8-dump-f2fs" class="headerlink" title="8.dump.f2fs"></a>8.dump.f2fs</h2><blockquote>
<p>stationPro:&#x2F; # dump.f2fs &#x2F;dev&#x2F;block&#x2F;dm-10<br>        Info: No support kernel version!<br>Info: Segments per section &#x3D; 1<br>Info: Sections per zone &#x3D; 1<br>Info: sector size &#x3D; 4096<br>Info: total sectors &#x3D; 27395539 (107013 MB)<br>        Invalid SB CRC offset: 2343108685<br>        Can’t find a valid F2FS superblock at 0x0<br>Magic Mismatch, valid(0xf2f52010) - read(0xdc209e9e)<br>        Can’t find a valid F2FS superblock at 0x1</p>
</blockquote>
<h3 id="Invalid-SB-CRC-offset"><a href="#Invalid-SB-CRC-offset" class="headerlink" title="Invalid SB CRC offset"></a>Invalid SB CRC offset</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> F2FS_SUPER_MAGIC        0xF2F52010      <span class="comment">/* F2FS Magic Number */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CP_CHKSUM_OFFSET        4092</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SB_CHKSUM_OFFSET        3068</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">verify_sb_chksum</span><span class="params">(<span class="keyword">struct</span> f2fs_super_block *sb)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">if</span> (SB_CHKSUM_OFFSET != get_sb(checksum_offset)) &#123;</span><br><span class="line">                MSG(<span class="number">0</span>, <span class="string">&quot;\tInvalid SB CRC offset: %u\n&quot;</span>,</span><br><span class="line">                                        get_sb(checksum_offset));</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (f2fs_crc_valid(get_sb(crc), sb,</span><br><span class="line">                        get_sb(checksum_offset))) &#123;</span><br><span class="line">                MSG(<span class="number">0</span>, <span class="string">&quot;\tInvalid SB CRC: 0x%x\n&quot;</span>, get_sb(crc));</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;c</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> get_sb(member)          \</span></span><br><span class="line"><span class="meta">                        (&#123;                                              \</span></span><br><span class="line"><span class="meta">                                typeof(sb-&gt;member) t;                   \</span></span><br><span class="line"><span class="meta">                                switch (sizeof(t)) &#123;                    \</span></span><br><span class="line"><span class="meta">                                case 8: t = get_sb_le64(member); break; \</span></span><br><span class="line"><span class="meta">                                case 4: t = get_sb_le32(member); break; \</span></span><br><span class="line"><span class="meta">                                case 2: t = get_sb_le16(member); break; \</span></span><br><span class="line"><span class="meta">                                &#125;                                       \</span></span><br><span class="line"><span class="meta">                                t; \</span></span><br><span class="line"><span class="meta">                        &#125;)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> get_sb_le32(member)                     le32_to_cpu(sb-&gt;member)</span></span><br></pre></td></tr></table></figure>



<h3 id="Magic-Mismatch-valid"><a href="#Magic-Mismatch-valid" class="headerlink" title="Magic Mismatch, valid"></a>Magic Mismatch, valid</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">sanity_check_raw_super</span><span class="params">(<span class="keyword">struct</span> f2fs_super_block *sb, <span class="keyword">enum</span> SB_ADDR sb_addr)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span> blocksize;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span> segment_count, segs_per_sec, secs_per_zone, segs_per_zone;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span> total_sections, blocks_per_seg;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((get_sb(feature) &amp; F2FS_FEATURE_SB_CHKSUM) &amp;&amp;</span><br><span class="line">                                        verify_sb_chksum(sb))</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (F2FS_SUPER_MAGIC != get_sb(magic)) &#123;</span><br><span class="line">                MSG(<span class="number">0</span>, <span class="string">&quot;Magic Mismatch, valid(0x%x) - read(0x%x)\n&quot;</span>,</span><br><span class="line">                        F2FS_SUPER_MAGIC, get_sb(magic));</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="Can’t-find-a-valid"><a href="#Can’t-find-a-valid" class="headerlink" title="Can’t find a valid"></a>Can’t find a valid</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">f2fs_do_mount</span><span class="params">(<span class="keyword">struct</span> f2fs_sb_info *sbi)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    ret = validate_super_block(sbi, SB0_ADDR);</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">            ret = validate_super_block(sbi, SB1_ADDR);</span><br><span class="line">            <span class="keyword">if</span> (ret)</span><br><span class="line">            	<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">validate_super_block</span><br><span class="line">	sanity_check_raw_super</span><br><span class="line">		verify_sb_chksum</span><br><span class="line">	<span class="string">&quot;Can&#x27;t find a valid F2FS superblock&quot;</span></span><br></pre></td></tr></table></figure>



<h3 id="正常文件系统"><a href="#正常文件系统" class="headerlink" title="正常文件系统"></a>正常文件系统</h3><h4 id="SIT部分"><a href="#SIT部分" class="headerlink" title="SIT部分"></a>SIT部分</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">stationPro:/data/test # dump.f2fs -s 0~-1 /dev/block/by-name/userdata</span><br><span class="line">        Info: No support kernel version!</span><br><span class="line">Info: Segments per section = 1</span><br><span class="line">Info: Sections per zone = 1</span><br><span class="line">Info: sector size = 4096</span><br><span class="line">Info: total sectors = 27395539 (107013 MB)</span><br><span class="line">Info: MKFS version</span><br><span class="line">  &quot;5.4.0-33-generic #37-Ubuntu SMP Thu May 21 12:53:59 UTC 2020&quot;</span><br><span class="line">Info: FSCK version</span><br><span class="line">  from &quot;4.19.157-perf&quot;</span><br><span class="line">    to &quot;4.19.157-perf&quot;</span><br><span class="line">Info: version timestamp cur: 1709547949, prev: 1709534712</span><br><span class="line">Info: superblock features = 481 :  encrypt verity quota_ino</span><br><span class="line">Info: superblock encrypt level = 0, salt = 00000000000000000000000000000000</span><br><span class="line">Info: total FS sectors = 27395539 (107013 MB)</span><br><span class="line">Info: CKPT version = 529c0a72</span><br><span class="line">Info: checkpoint state = 10c0 :  nat_bits crc disabled sudden-power-off</span><br><span class="line"></span><br><span class="line">Done: 0.092350 secs</span><br></pre></td></tr></table></figure>



<h4 id="SSA部分"><a href="#SSA部分" class="headerlink" title="SSA部分"></a>SSA部分</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">stationPro:/data/test # dump.f2fs -a 0~-1 /dev/block/by-name/userdata</span><br><span class="line">        Info: No support kernel version!</span><br><span class="line">Info: Segments per section = 1</span><br><span class="line">Info: Sections per zone = 1</span><br><span class="line">Info: sector size = 4096</span><br><span class="line">Info: total sectors = 27395539 (107013 MB)</span><br><span class="line">Info: MKFS version</span><br><span class="line">  &quot;5.4.0-33-generic #37-Ubuntu SMP Thu May 21 12:53:59 UTC 2020&quot;</span><br><span class="line">Info: FSCK version</span><br><span class="line">  from &quot;4.19.157-perf&quot;</span><br><span class="line">    to &quot;4.19.157-perf&quot;</span><br><span class="line">Info: version timestamp cur: 1709547986, prev: 1709534712</span><br><span class="line">Info: superblock features = 481 :  encrypt verity quota_ino</span><br><span class="line">Info: superblock encrypt level = 0, salt = 00000000000000000000000000000000</span><br><span class="line">Info: total FS sectors = 27395539 (107013 MB)</span><br><span class="line">Info: CKPT version = 529c0a72</span><br><span class="line">Info: checkpoint state = 10c0 :  nat_bits crc disabled sudden-power-off</span><br><span class="line"></span><br><span class="line">Done: 21.470205 secs</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/2020082519461895.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4MjMyNDM3,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>从结构图可以知道，SSA区域由N个struct f2fs_summary_block组成，每一个struct f2fs_summary_block包含了512个struct f2fs_summary_entry，刚好对应一个segment。segment里面的每一个block(物理地址)对应一个的struct f2fs_summary_entry，它记录了物理地址到逻辑地址的映射信息。它包含了三个变量: nid(该物理地址是属于哪一个node的)，version(用于数据恢复)，ofs_in_node(该物理地址属于该nid对应的node的第ofs_in_node个block,偏移量)。</p>
<p>可以通过导出日志查看nid与物理地址的映射关系</p>
<p><img src="C:\Users\rokid\AppData\Roaming\Typora\typora-user-images\image-20240310150427018.png" alt="image-20240310150427018"></p>
<h4 id="NAT部分"><a href="#NAT部分" class="headerlink" title="NAT部分"></a>NAT部分</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">stationPro:/data/test # dump.f2fs -n 0~-1 /dev/block/by-name/userdata</span><br><span class="line">        Info: No support kernel version!</span><br><span class="line">Info: Segments per section = 1</span><br><span class="line">Info: Sections per zone = 1</span><br><span class="line">Info: sector size = 4096</span><br><span class="line">Info: total sectors = 27395539 (107013 MB)</span><br><span class="line">Info: MKFS version</span><br><span class="line">  &quot;5.4.0-33-generic #37-Ubuntu SMP Thu May 21 12:53:59 UTC 2020&quot;</span><br><span class="line">Info: FSCK version</span><br><span class="line">  from &quot;4.19.157-perf&quot;</span><br><span class="line">    to &quot;4.19.157-perf&quot;</span><br><span class="line">Info: version timestamp cur: 1709547912, prev: 1709534712</span><br><span class="line">Info: superblock features = 481 :  encrypt verity quota_ino</span><br><span class="line">Info: superblock encrypt level = 0, salt = 00000000000000000000000000000000</span><br><span class="line">Info: total FS sectors = 27395539 (107013 MB)</span><br><span class="line">Info: CKPT version = 529c0a72</span><br><span class="line">Segmentation fault</span><br></pre></td></tr></table></figure>



<h2 id="9-回写"><a href="#9-回写" class="headerlink" title="9.回写"></a>9.回写</h2><h3 id="9-1-报错调用栈"><a href="#9-1-报错调用栈" class="headerlink" title="9.1 报错调用栈"></a>9.1 报错调用栈</h3><blockquote>
<p>[ 3827.193668] Call trace:<br>[ 3827.193670]  change_curseg+0x320&#x2F;0x388<br>[ 3827.193672]  allocate_segment_by_default+0x17c&#x2F;0x1cc<br>[ 3827.193673]  f2fs_allocate_data_block+0x4d4&#x2F;0x770<br>[ 3827.193674]  do_write_page+0x80&#x2F;0x1a8<br>[ 3827.193675]  f2fs_outplace_write_data+0x58&#x2F;0x130<br>[ 3827.193676]  f2fs_do_write_data_page+0x3e4&#x2F;0x7d8<br>[ 3827.193677]  f2fs_write_single_data_page+0x4d8&#x2F;0x780<br>[ 3827.193678]  f2fs_write_data_pages+0x4d8&#x2F;0x700<br>[ 3827.193681]  do_writepages+0x64&#x2F;0x118<br>[ 3827.193682]  __writeback_single_inode+0xdc&#x2F;0x4b0<br>[ 3827.193683]  writeback_sb_inodes+0x468&#x2F;0x9e0<br>[ 3827.193684]  __writeback_inodes_wb+0xa4&#x2F;0x1b0<br>[ 3827.193685]  wb_writeback+0x270&#x2F;0x438<br>[ 3827.193686]  wb_workfn+0x3a8&#x2F;0x630<br>[ 3827.193689]  process_one_work+0x27c&#x2F;0x448<br>[ 3827.193690]  worker_thread+0x264&#x2F;0x4b0<br>[ 3827.193691]  kthread+0x144&#x2F;0x158<br>[ 3827.193693]  ret_from_fork+0x10&#x2F;0x1c<br>[ 3827.193694] —[ end trace e0724141b9490fbe ]—</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">wb_workfn</span><br><span class="line">    wb_do_writeback</span><br><span class="line">        wb_check_background_flush</span><br><span class="line">            wb_check_background_flush</span><br><span class="line">            </span><br><span class="line">            </span><br><span class="line"><span class="type">static</span> <span class="type">long</span> <span class="title function_">wb_check_background_flush</span><span class="params">(<span class="keyword">struct</span> bdi_writeback *wb)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (wb_over_bg_thresh(wb)) &#123;</span><br><span class="line"></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">wb_writeback_work</span> <span class="title">work</span> =</span> &#123;</span><br><span class="line">			.nr_pages	= LONG_MAX,</span><br><span class="line">			.sync_mode	= WB_SYNC_NONE,</span><br><span class="line">			.for_background	= <span class="number">1</span>,</span><br><span class="line">			.range_cyclic	= <span class="number">1</span>,</span><br><span class="line">			.reason		= WB_REASON_BACKGROUND, <span class="comment">//脏页到达阈值</span></span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> wb_writeback(wb, &amp;work);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="9-2-尝试复现"><a href="#9-2-尝试复现" class="headerlink" title="9.2 尝试复现"></a>9.2 尝试复现</h3><p><img src="C:\Users\rokid\AppData\Roaming\Typora\typora-user-images\image-20240310165131085.png" alt="image-20240310165131085"></p>
<p>脏页超过10%，但是回写流程没有走到f2fs_writeback</p>
<p>复现步骤如下：</p>
<p>1.先写裸盘</p>
<p>dd if&#x3D;&#x2F;dev&#x2F;zero of&#x3D;&#x2F;dev&#x2F;block&#x2F;by-name&#x2F;userdata bs&#x3D;1g count&#x3D;100</p>
<p>2.写文件到data分区，触发脏页回写</p>
<p>d if&#x3D;&#x2F;dev&#x2F;zero of&#x3D;&#x2F;data&#x2F;test bs&#x3D;1g count&#x3D;100</p>
<p>3.查看flush进程调用栈</p>
<p><img src="C:\Users\rokid\AppData\Roaming\Typora\typora-user-images\image-20240310170115101.png" alt="image-20240310170115101"></p>
<blockquote>
<p>[&lt;0&gt;] __switch_to+0x11c&#x2F;0x128<br>[&lt;0&gt;] get_request+0x788&#x2F;0x988<br>[&lt;0&gt;] blk_queue_bio+0x20c&#x2F;0x500<br>[&lt;0&gt;] generic_make_request+0x218&#x2F;0x388<br>[&lt;0&gt;] submit_bio+0x60&#x2F;0x228<br>[&lt;0&gt;] __submit_merged_bio+0x398&#x2F;0x510<br>[&lt;0&gt;] f2fs_submit_page_write+0x484&#x2F;0x840 &#x2F;&#x2F;!!!!!<br>[&lt;0&gt;] do_write_page+0x98&#x2F;0x1a8<br>[&lt;0&gt;] f2fs_outplace_write_data+0x58&#x2F;0x130<br>[&lt;0&gt;] f2fs_do_write_data_page+0x3e4&#x2F;0x7d8<br>[&lt;0&gt;] f2fs_write_single_data_page+0x4d8&#x2F;0x780<br>[&lt;0&gt;] f2fs_write_data_pages+0x4d8&#x2F;0x700<br>[&lt;0&gt;] do_writepages+0x64&#x2F;0x118<br>[&lt;0&gt;] __writeback_single_inode+0xdc&#x2F;0x4b0<br>[&lt;0&gt;] writeback_sb_inodes+0x468&#x2F;0x9e0<br>[&lt;0&gt;] __writeback_inodes_wb+0xa4&#x2F;0x1b0<br>[&lt;0&gt;] wb_writeback+0x270&#x2F;0x438<br>[&lt;0&gt;] wb_workfn+0x3a8&#x2F;0x630<br>[&lt;0&gt;] process_one_work+0x27c&#x2F;0x448<br>[&lt;0&gt;] worker_thread+0x264&#x2F;0x4b0<br>[&lt;0&gt;] kthread+0x144&#x2F;0x158<br>[&lt;0&gt;] ret_from_fork+0x10&#x2F;0x1c<br>[&lt;0&gt;] 0xffffffffffffffff</p>
</blockquote>
<p>在data分区下写入文件，会走到f2fs_write_data_page，</p>
<p>对比问题调用栈发现正常流程不会挂在f2fs_allocate_data_block里面</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">do_write_page</span><span class="params">(<span class="keyword">struct</span> f2fs_summary *sum, <span class="keyword">struct</span> f2fs_io_info *fio)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> type = __get_segment_type(fio);</span><br><span class="line">	<span class="type">bool</span> keep_order = (f2fs_lfs_mode(fio-&gt;sbi) &amp;&amp; type == CURSEG_COLD_DATA);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (keep_order)</span><br><span class="line">		down_read(&amp;fio-&gt;sbi-&gt;io_order_lock);</span><br><span class="line">reallocate:</span><br><span class="line">	f2fs_allocate_data_block(fio-&gt;sbi, fio-&gt;page, fio-&gt;old_blkaddr,</span><br><span class="line">			&amp;fio-&gt;new_blkaddr, sum, type, fio, <span class="literal">true</span>);</span><br><span class="line">	<span class="keyword">if</span> (GET_SEGNO(fio-&gt;sbi, fio-&gt;old_blkaddr) != NULL_SEGNO)</span><br><span class="line">		invalidate_mapping_pages(META_MAPPING(fio-&gt;sbi),</span><br><span class="line">					fio-&gt;old_blkaddr, fio-&gt;old_blkaddr);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* writeout dirty page into bdev */</span></span><br><span class="line">	f2fs_submit_page_write(fio); <span class="comment">//本地复现走到这里</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>错误调用栈：</p>
<p>[ 3827.193670]  change_curseg+0x320&#x2F;0x388</p>
<p>[ 3827.193672]  allocate_segment_by_default+0x17c&#x2F;0x1cc</p>
<p>[ 3827.193673]  f2fs_allocate_data_block+0x4d4&#x2F;0x770</p>
<p>[ 3827.193674]  do_write_page+0x80&#x2F;0x1a8</p>
</blockquote>
<p>说明本地复现在f2fs_allocate_data_block函数没有问题</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">f2fs_allocate_data_block</span><span class="params">(<span class="keyword">struct</span> f2fs_sb_info *sbi, <span class="keyword">struct</span> page *page,</span></span><br><span class="line"><span class="params">		<span class="type">block_t</span> old_blkaddr, <span class="type">block_t</span> *new_blkaddr,</span></span><br><span class="line"><span class="params">		<span class="keyword">struct</span> f2fs_summary *sum, <span class="type">int</span> type,</span></span><br><span class="line"><span class="params">		<span class="keyword">struct</span> f2fs_io_info *fio, <span class="type">bool</span> add_list)</span></span><br><span class="line">&#123;</span><br><span class="line">	...</span><br><span class="line">	<span class="keyword">if</span> (!__has_curseg_space(sbi, type))</span><br><span class="line">		sit_i-&gt;s_ops-&gt;allocate_segment(sbi, type, <span class="literal">false</span>); </span><br><span class="line">	...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">bool</span> __has_curseg_space(<span class="keyword">struct</span> f2fs_sb_info *sbi, <span class="type">int</span> type)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">curseg_info</span> *<span class="title">curseg</span> =</span> CURSEG_I(sbi, type);</span><br><span class="line">	<span class="keyword">if</span> (curseg-&gt;next_blkoff &lt; sbi-&gt;blocks_per_seg)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="加打印发现正常流程也会走到"><a href="#加打印发现正常流程也会走到" class="headerlink" title="加打印发现正常流程也会走到"></a>加打印发现正常流程也会走到</h4><p><img src="C:\Users\rokid\AppData\Roaming\Typora\typora-user-images\image-20240311111335764.png" alt="image-20240311111335764"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">f2fs_sb_info fffffffbc72e6000</span><br><span class="line"></span><br><span class="line">f2fs_sm_info = f2fs_sb_info -&gt; sm_info</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">crash&gt; </span><span class="language-bash">f2fs_sb_info -xo | grep sm_info</span></span><br><span class="line">   [0x88] struct f2fs_sm_info *sm_info;</span><br><span class="line">   </span><br><span class="line">rd fffffffbc72e6088 -&gt; f2fs_sm_info fffffffbc8ce1600</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">crash&gt; </span><span class="language-bash">f2fs_sm_info -xo | grep curseg</span></span><br><span class="line">  [0x18] struct curseg_info *curseg_array;</span><br><span class="line">  </span><br><span class="line">rd fffffffbc8ce1618 -&gt; curseg_info fffffffbc7368c00</span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">bool</span> __has_curseg_space(<span class="keyword">struct</span> f2fs_sb_info *sbi, <span class="type">int</span> type)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">curseg_info</span> *<span class="title">curseg</span> =</span> CURSEG_I(sbi, type);</span><br><span class="line">	<span class="keyword">if</span> (curseg-&gt;next_blkoff &lt; sbi-&gt;blocks_per_seg)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">crash&gt; curseg_info fffffffbc7368c00 | grep next_blkoff</span><br><span class="line">  next_blkoff = <span class="number">400</span>,</span><br><span class="line"></span><br><span class="line">crash&gt; f2fs_sb_info fffffffbc72e6000 | grep -w blocks_per_seg</span><br><span class="line">  blocks_per_seg = <span class="number">512</span>,</span><br><span class="line"></span><br><span class="line">crash&gt; curseg_info -xo | grep sum_blk</span><br><span class="line">  [<span class="number">0x20</span>] <span class="keyword">struct</span> f2fs_summary_block *sum_blk;</span><br><span class="line"></span><br><span class="line">f2fs_summary_block* = curseg_info + <span class="number">0x20</span> = fffffffbc7368c20</span><br><span class="line">    </span><br><span class="line">f2fs_summary_block fffffffbc8c2b000</span><br></pre></td></tr></table></figure>



<p>偶然recovery，清理data分区后启动日志</p>
<p><img src="C:\Users\rokid\AppData\Roaming\Typora\typora-user-images\image-20240311115854167.png" alt="image-20240311115854167"></p>
<h2 id="10-复现"><a href="#10-复现" class="headerlink" title="10.复现"></a>10.复现</h2><p><img src="C:\Users\rokid\AppData\Roaming\Typora\typora-user-images\image-20240312110804499.png" alt="image-20240312110804499"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">verify_checksum_chksum</span><span class="params">(<span class="keyword">struct</span> f2fs_checkpoint *cp)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span> chksum_offset = get_cp(checksum_offset);</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span> crc, cal_crc;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (chksum_offset &lt; CP_MIN_CHKSUM_OFFSET ||</span><br><span class="line">                        chksum_offset &gt; CP_CHKSUM_OFFSET) &#123;</span><br><span class="line">                MSG(<span class="number">0</span>, <span class="string">&quot;\tInvalid CP CRC offset: %u\n&quot;</span>, chksum_offset);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">		...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CP_BITMAP_OFFSET        \</span></span><br><span class="line"><span class="meta">        (offsetof(struct f2fs_checkpoint, sit_nat_version_bitmap))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CP_MIN_CHKSUM_OFFSET    CP_BITMAP_OFFSET</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CP_CHKSUM_OFFSET        4092</span></span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\rokid\AppData\Roaming\Typora\typora-user-images\image-20240312110952723.png" alt="image-20240312110952723"></p>
<p><img src="C:\Users\rokid\AppData\Roaming\Typora\typora-user-images\image-20240312112037639.png" alt="image-20240312112037639"></p>
<h2 id="3-10问题进展同步"><a href="#3-10问题进展同步" class="headerlink" title="3-10问题进展同步"></a>3-10问题进展同步</h2><h3 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h3><p>按表象应该可以分为2个问题：</p>
<p>1.f2fs文件系统损坏-&gt;recovery模式</p>
<p>2.f2fs文件系统损坏-&gt;f2fs oops（梦云复现）-&gt; 红灯 -&gt; 收集完QPST内存数据后进入recovery</p>
<h3 id="当前进展："><a href="#当前进展：" class="headerlink" title="当前进展："></a>当前进展：</h3><p>（1）亿境复现recovery问题，recovery原因和&#x2F;data&#x2F;tombstons有关，与之前fs_mgr_mount_all原因不同；亿境建议合入补丁disable掉tombstones的加密策略，待复现查看tombstones日志排除进程crash的影响</p>
<p>![60a4f2ace4837deb6353c3c9aa9ce64](C:\Users\rokid\Documents\WeChat Files\wxid_9qt4buce6r2v22\FileStorage\Temp\60a4f2ace4837deb6353c3c9aa9ce64.png)</p>
<h3 id="历史进展："><a href="#历史进展：" class="headerlink" title="历史进展："></a>历史进展：</h3><p>（1）与亿境对齐，疑问点中resize.f2fs的返回值0xff00含义表示命令正常执行结束；</p>
<p>（2）invalid blkaddr打印重启修复补丁已打入，待复现后验证有效性；</p>
<p>（3）dump.f2fs思路不可行，元数据信息会被加密，无法得知物理地址被什么内容写入；</p>
<p>（4）排查最近提交，都是apk相关修改，无异常点</p>
<h3 id="计划："><a href="#计划：" class="headerlink" title="计划："></a>计划：</h3><p>1.为啥fsck.f2fs会在inode&#x3D;948处循环很久？此疑问待找到必现或者高概率复现方法再加打印继续分析</p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p>1、<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/637700821">f2fs文件系统（三）SIT介绍 - 知乎 (zhihu.com)</a></p>
<p>2、<a target="_blank" rel="noopener" href="https://juejin.cn/post/7260677992338014266">一个F2FS文件系统Data分区损坏的真实案例 - 掘金 (juejin.cn)</a></p>

        
        <br />
        <div id="comment-container">
        </div>
        <div id="disqus_thread"></div>
        <div id="lv-container"></div>
        <div class="giscus"></div>
    </div>
</div>

    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        

        

    </ul>
    
    <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>
        Created By <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>  Theme <a target="_blank" rel="noopener" href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a></p>
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = ""
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>

<script src="/js/index.js"></script>

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>






</html>
