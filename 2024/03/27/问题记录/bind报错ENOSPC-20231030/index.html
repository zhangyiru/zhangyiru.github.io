<!DOCTYPE html>
<html lang=zh-CN>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta property="og:description" content="">
    <meta property="og:type" content="website">
    <meta name="description" content="">
    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
        wlan crash【bind报错ENOSPC】 - zddzdd
        
    </title>

    <!-- Custom CSS -->
    
<link rel="stylesheet" href="/css/aircloud.css">

    
<link rel="stylesheet" href="/css/gitment.css">

    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_28hi1hpxx24.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>

    









<meta name="generator" content="Hexo 7.1.1"><link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
</head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i>  </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar ">
		<img src="/img/wanwan.jpg" class="js-avatar show"/>
	</div>
        <div class="name">
            <i>Xayahion</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li >
                <a href="/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>主页</span>
                </a>
            </li>
            <li >
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>标签</span>
                </a>
            </li>
            <li >
                <a href="/archives">
                    <i class="iconfont icon-guidang2"></i>
                    <span>存档</span>
                </a>
            </li>
            <li >
                <a href="/collect/">
                    <i class="iconfont icon-shoucang1"></i>
                    <span>收藏</span>
                </a>
            </li>
            <li >
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>关于</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#wlan-crash"><span class="toc-text">wlan crash</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%80%83%E8%99%91data%E5%88%86%E5%8C%BA%E5%86%85%E5%AD%98%E4%B8%8D%E8%B6%B3"><span class="toc-text">考虑data分区内存不足</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E6%80%81cnss%E6%8A%A5%E9%94%99%E5%87%BD%E6%95%B0"><span class="toc-text">用户态cnss报错函数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#sun-path-CNSS-USER-SERVER"><span class="toc-text">sun_path -&gt; CNSS_USER_SERVER</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#bind-unix"><span class="toc-text">bind unix</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#socket%E7%BB%93%E6%9E%84%E4%BD%93"><span class="toc-text">socket结构体</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#bind%E5%BA%95%E5%B1%82%E8%B0%83%E7%94%A8%E5%85%B3%E7%B3%BB"><span class="toc-text">bind底层调用关系</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#unix-autobind"><span class="toc-text">unix_autobind</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#unix-find-socket-byname"><span class="toc-text">__unix_find_socket_byname</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#unix-socket-table"><span class="toc-text">unix_socket_table</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%B9%E6%AF%94%E6%AD%A3%E5%B8%B8%E7%8E%AF%E5%A2%83%E7%9A%84unix-socket-table"><span class="toc-text">对比正常环境的unix_socket_table</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%8D%E6%8E%A8%E5%B9%B6%E6%B2%A1%E6%9C%89%E8%B5%B0%E5%88%B0unix-autobind%E5%87%BD%E6%95%B0%EF%BC%8C%E5%86%8D%E6%AC%A1%E5%AE%A1%E8%A7%86unix-bind%E5%87%BD%E6%95%B0"><span class="toc-text">反推并没有走到unix_autobind函数，再次审视unix_bind函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E5%8F%A5%E8%AF%9D%E7%BB%93%E8%AE%BA"><span class="toc-text">一句话结论</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%82%A3%E4%B9%88%E8%B0%81%E5%8D%A0%E7%94%A8%E4%BA%86data%E5%88%86%E5%8C%BA%EF%BC%9F"><span class="toc-text">那么谁占用了data分区？</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#super-block%E4%B8%8Ef2fs-sb-info%E7%9A%84%E8%81%94%E7%B3%BB"><span class="toc-text">super_block与f2fs_sb_info的联系</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#f2fs-superblock%E7%BB%93%E6%9E%84"><span class="toc-text">f2fs superblock结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%96%91%E9%97%AE%E7%82%B9%EF%BC%9A%E4%B8%BA%E5%95%A5%E6%B2%A1%E6%9C%89gc%E5%87%BA%E7%A9%BA%E9%97%B4"><span class="toc-text">疑问点：为啥没有gc出空间</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E3%80%90%E6%8D%A2%E4%B8%AA%E6%80%9D%E8%B7%AF%E3%80%91%E4%BB%8E%E8%BF%9B%E7%A8%8B%E6%89%93%E5%BC%80%E7%9A%84%E6%96%87%E4%BB%B6%E8%A7%92%E5%BA%A6%E7%9C%8B"><span class="toc-text">【换个思路】从进程打开的文件角度看</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E5%8F%A5%E8%AF%9D%E7%BB%93%E8%AE%BA-1"><span class="toc-text">一句话结论</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%A4%8D%E7%8E%B0"><span class="toc-text">如何复现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="toc-text">参考链接</span></a></li></ol></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-bg" id="search-bg"></div>
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input"/>
            <span id="begin-search">搜索</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>

        <div class="index-about-mobile">
            <i>  </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        wlan crash【bind报错ENOSPC】
    </div>

    <div class="post-meta">
        <span class="attr">发布于：<span>2024-03-27 15:12:51</span></span>
        
        <span class="attr">标签：/
        
        <a class="tag" href="/tags/#problem" title="problem">problem</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">访问：<span id="busuanzi_value_page_pv"></span>
</span>
</span>
    </div>
    <div class="post-content ">
        <h2 id="wlan-crash"><a href="#wlan-crash" class="headerlink" title="wlan crash"></a>wlan crash</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">[   <span class="number">66.175350</span>] cnss-daemon: interop issues ap: read_iot_ap_file: No such file /data/vendor/wifi/iotap_ps.bin</span><br><span class="line">[   <span class="number">66.175356</span>] cnss-daemon: interop issues ap: read_iot_ap_ps_from_file, read file error</span><br><span class="line">[   <span class="number">66.175469</span>] cnss-daemon: Fail to bind user socket No space left on device</span><br><span class="line">[   <span class="number">66.175477</span>] cnss-daemon: Failed to init user interface</span><br><span class="line">[   <span class="number">66.175517</span>] cnss-daemon: interop issues ap: save_iot_ap_file: Failed to open file /data/vendor/wifi/iotap_ps.bin</span><br><span class="line">[   <span class="number">66.175520</span>] cnss-daemon: interop issues ap: save_iot_ap_ps_to_file, save file error</span><br><span class="line">...</span><br><span class="line">[   <span class="number">70.558379</span>] init: Could not store persistent property: Could not open temporary properties file: No space left on device</span><br><span class="line">[   <span class="number">70.584538</span>] msm_qti_pp_get_rms_value_control, back not active to query rms be_idx:<span class="number">3</span></span><br><span class="line">[   <span class="number">70.596279</span>] core_get_license_status: cmdrsp_license_result.result = <span class="number">0x15</span> <span class="keyword">for</span> module <span class="number">0x131ff</span></span><br><span class="line">[   <span class="number">70.596637</span>] msm_ext_disp_update_audio_ops: Display not found (EXT_DISPLAY_TYPE_HDMI) ctld (<span class="number">0</span>) stream (<span class="number">0</span>)</span><br><span class="line">[   <span class="number">70.607535</span>] msm-ext-disp-audio-codec-rx soc:qcom,msm-ext-disp:qcom,msm-ext-disp-audio-codec-rx: msm_ext_disp_audio_device_get: invalid dai id: <span class="number">4</span></span><br><span class="line">[   <span class="number">70.624021</span>] cnss: fatal: Timeout waiting <span class="keyword">for</span> FW ready indication</span><br><span class="line">[   <span class="number">70.630204</span>] cnss: Update driver status: <span class="number">4</span></span><br><span class="line">[   <span class="number">70.630216</span>] cnss: Posting event: RECOVERY(<span class="number">9</span>), state: <span class="number">0x11</span> flags: <span class="number">0x0</span></span><br><span class="line">[   <span class="number">70.630217</span>] cnss: PM stay awake, state: <span class="number">0x11</span>, count: <span class="number">1</span></span><br><span class="line">[   <span class="number">70.630226</span>] cnss: PM relax, state: <span class="number">0x11</span>, count: <span class="number">0</span></span><br><span class="line">[   <span class="number">70.630230</span>] cnss: PM stay awake, state: <span class="number">0x11</span>, count: <span class="number">1</span></span><br><span class="line">[   <span class="number">70.630233</span>] cnss: Processing driver event: RECOVERY(<span class="number">9</span>), state: <span class="number">0x11</span></span><br><span class="line">[   <span class="number">70.630235</span>] cnss: Driver recovery is triggered with reason: TIMEOUT(<span class="number">3</span>)</span><br><span class="line">[   <span class="number">70.630240</span>] subsys-restart: subsystem_restart_dev(): Restart sequence requested <span class="keyword">for</span> wlan, restart_level = SYSTEM.</span><br><span class="line">[   <span class="number">70.630246</span>] cnss: PM relax, state: <span class="number">0x611</span>, count: <span class="number">0</span></span><br><span class="line">[   <span class="number">70.640767</span>] msm_adsp_stream_callback_get: ASM Stream PP event <span class="built_in">queue</span> is empty.</span><br><span class="line">[   <span class="number">70.655599</span>] msm_pcm_volume_ctl_get substream not found</span><br><span class="line">[   <span class="number">70.667346</span>] binder: <span class="number">6681</span>:<span class="number">6681</span> ioctl <span class="number">40046210</span> <span class="number">7f</span>c5227c24 returned <span class="number">-22</span></span><br><span class="line">[   <span class="number">70.732033</span>] Kernel panic - not syncing: subsys-restart: Resetting the SoC - wlan crashed.</span><br><span class="line">[   <span class="number">70.740438</span>] CPU: <span class="number">5</span> PID: <span class="number">78</span> Comm: kworker/<span class="number">5</span>:<span class="number">1</span> Tainted: G S      W  O      <span class="number">4.19</span><span class="number">.157</span>-perf #<span class="number">1</span></span><br><span class="line">[   <span class="number">70.748834</span>] Hardware name: Qualcomm Technologies, Inc. kona-xr-overlay Standalone (DT)</span><br><span class="line">[   <span class="number">70.756982</span>] Workqueue: events device_restart_work_hdlr</span><br><span class="line">[   <span class="number">70.762272</span>] Call trace:</span><br><span class="line">[   <span class="number">70.763745</span>] msm_qti_pp_get_rms_value_control, back not active to query rms be_idx:<span class="number">3</span></span><br><span class="line">[   <span class="number">70.810796</span>]  dump_backtrace+<span class="number">0x0</span>/<span class="number">0x208</span></span><br><span class="line">[   <span class="number">70.810798</span>]  show_stack+<span class="number">0x14</span>/<span class="number">0x20</span></span><br><span class="line">[   <span class="number">70.810801</span>]  dump_stack+<span class="number">0xb8</span>/<span class="number">0xf4</span></span><br><span class="line">[   <span class="number">70.810802</span>]  panic+<span class="number">0x158</span>/<span class="number">0x2d8</span></span><br><span class="line">[   <span class="number">70.810805</span>]  device_restart_work_hdlr+<span class="number">0x44</span>/<span class="number">0x48</span></span><br><span class="line">[   <span class="number">70.823290</span>] core_get_license_status: cmdrsp_license_result.result = <span class="number">0x15</span> <span class="keyword">for</span> module <span class="number">0x131ff</span></span><br><span class="line">[   <span class="number">70.825875</span>]  process_one_work+<span class="number">0x278</span>/<span class="number">0x440</span></span><br><span class="line">[   <span class="number">70.825876</span>]  worker_thread+<span class="number">0x260</span>/<span class="number">0x4a8</span></span><br><span class="line">[   <span class="number">70.825877</span>]  kthread+<span class="number">0x140</span>/<span class="number">0x150</span></span><br><span class="line">[   <span class="number">70.825878</span>]  ret_from_fork+<span class="number">0x10</span>/<span class="number">0x18</span></span><br><span class="line">[   <span class="number">70.825881</span>] SMP: stopping secondary CPUs</span><br></pre></td></tr></table></figure>

<p>日志推断空间不足导致cnss超时，最终restart soc导致crash</p>
<h3 id="考虑data分区内存不足"><a href="#考虑data分区内存不足" class="headerlink" title="考虑data分区内存不足"></a>考虑data分区内存不足</h3><p>看到ENOSPC首先想到是空间不足，但是kmem看free很多</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">crash&gt; </span><span class="language-bash">mount | grep data</span></span><br><span class="line">ffffffc70cd3ad80 ffffffc59e09f800 ext4   /dev/block/by-name/metadata /metadata </span><br><span class="line">ffffffc70cd3b640 ffffffc59e3c7000 ext4   /dev/block/dm-10 /apex/com.android.tzdata</span><br><span class="line">ffffffc736581180 ffffffc70bdfe000 f2fs   /dev/block/dm-15 /data     </span><br><span class="line">ffffffc713b48380 ffffffc70bdfe000 f2fs   /dev/block/dm-15 /data/user/0</span><br><span class="line">ffffffc736582840 ffffffc70bdff800 tmpfs  tmpfs     /data_mirror</span><br><span class="line">ffffffc736582680 ffffffc70bdfe000 f2fs   /dev/block/dm-15 /data_mirror/data_ce/null</span><br><span class="line">ffffffc736583640 ffffffc70bdfe000 f2fs   /dev/block/dm-15 /data_mirror/data_ce/null/user/0</span><br><span class="line">ffffffc736583800 ffffffc70bdfe000 f2fs   /dev/block/dm-15 /data_mirror/data_de/null</span><br><span class="line">ffffffc713b48fc0 ffffffc70bdfe000 f2fs   /dev/block/dm-15 /data_mirror/cur_profiles</span><br><span class="line">ffffffc736580000 ffffffc70bdfe000 f2fs   /dev/block/dm-15 /data_mirror/ref_profiles</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">crash&gt; </span><span class="language-bash">dev -d</span></span><br><span class="line">MAJOR GENDISK            NAME       REQUEST_QUEUE      TOTAL ASYNC  SYNC   DRV</span><br><span class="line">  254 ffffffc712f53800   zram0      ffffffc712e26b40       0     0     0     0</span><br><span class="line">    8 ffffffc7120f6800   sda        ffffffc59e17b0c0       0     0     0     0</span><br><span class="line">    8 ffffffc59e1f6800   sdb        ffffffc59e17c440       0     0     0     0</span><br><span class="line">    8 ffffffc59e1f7000   sdc        ffffffc59e17f500       0     0     0     0</span><br><span class="line">    8 ffffffc59e1f0800   sdf        ffffffc59e17ba80       0     0     0     0</span><br><span class="line">    8 ffffffc59e1f5000   sdd        ffffffc59e17ce00       0     0     0     0</span><br><span class="line">    8 ffffffc59e1f2800   sde        ffffffc59e17e180       0     0     0     0</span><br><span class="line">  252 ffffffc59e099800   dm-0       ffffffc59dd4ba80       0     0     0     0</span><br><span class="line">  252 ffffffc59dd7d800   dm-1       ffffffc59dd48000       0     0     0     0</span><br><span class="line">  252 ffffffc59dd7f800   dm-2       ffffffc59dd49380       0     0     0     0</span><br><span class="line">  252 ffffffc59dd7c000   dm-3       ffffffc59dd4eb40       0     0     0     0</span><br><span class="line">  252 ffffffc59dd79800   dm-4       ffffffc59dd4a700       0     0     0     0</span><br><span class="line">  252 ffffffc59dd7b000   dm-5       ffffffc59dd49d40       0     0     0     0</span><br><span class="line">  252 ffffffc59dd79000   dm-6       ffffffc59dd4d7c0       0     0     0     0</span><br><span class="line">  252 ffffffc59dd9f000   dm-7       ffffffc59dd489c0       0     0     0     0</span><br><span class="line">  252 ffffffc59dd9d000   dm-8       ffffffc59dd4b0c0       0     0     0     0</span><br><span class="line">  252 ffffffc59dd9a800   dm-9       ffffffc59dd4c440       0     0     0     0</span><br><span class="line">  252 ffffffc59dd98800   dm-10      ffffffc59dd4f500       0     0     0     0</span><br><span class="line">  252 ffffffc59e30d000   dm-11      ffffffc59e178000       0     0     0     0</span><br><span class="line">  252 ffffffc59d82d800   dm-12      ffffffc59e179380       0     0     0     0</span><br><span class="line">  252 ffffffc59d82c000   dm-13      ffffffc59e17eb40       0     0     0     0</span><br><span class="line">  252 ffffffc59d9dd800   dm-14      ffffffc59e17a700       0     0     0     0</span><br><span class="line">  252 ffffffc70c5cc000   dm-15      ffffffc707cace00       0     0     0     0</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">crash&gt; kmem -i</span><br><span class="line">                 PAGES        TOTAL      PERCENTAGE</span><br><span class="line">    TOTAL MEM  3007109      11.5 GB         ----</span><br><span class="line">         FREE  1941920       7.4 GB   64% of TOTAL MEM</span><br><span class="line">         USED  1065189       4.1 GB   35% of TOTAL MEM</span><br><span class="line">       SHARED   114800     448.4 MB    3% of TOTAL MEM</span><br><span class="line">      BUFFERS     1407       5.5 MB    0% of TOTAL MEM</span><br><span class="line">       CACHED   208340     813.8 MB    6% of TOTAL MEM</span><br><span class="line">         SLAB    42807     167.2 MB    1% of TOTAL MEM</span><br><span class="line"></span><br><span class="line">   TOTAL HUGE        0            0         ----</span><br><span class="line">    HUGE FREE        0            0    0% of TOTAL HUGE</span><br><span class="line"></span><br><span class="line">   TOTAL SWAP        0            0         ----</span><br><span class="line">    SWAP USED        0            0    0% of TOTAL SWAP</span><br><span class="line">    SWAP FREE        0            0    0% of TOTAL SWAP</span><br><span class="line"></span><br><span class="line"> COMMIT LIMIT  1503554       5.7 GB         ----</span><br><span class="line">    COMMITTED  1772605       6.8 GB  117% of TOTAL LIMIT</span><br></pre></td></tr></table></figure>



<p>高通回复：</p>
<p><img src="C:\Users\rokid\AppData\Roaming\Typora\typora-user-images\image-20231109143700131.png" alt="image-20231109143700131"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">int</span> <span class="title function_">utilization</span><span class="params">(<span class="keyword">struct</span> f2fs_sb_info *sbi)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">return</span> div_u64((u64)valid_user_blocks(sbi) * <span class="number">100</span>,</span><br><span class="line">                                        sbi-&gt;user_block_count);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">u64 <span class="title function_">div_u64</span><span class="params">(u64 dividend, u32 divisor)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> dividend / divisor;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">block_t</span> <span class="title function_">valid_user_blocks</span><span class="params">(<span class="keyword">struct</span> f2fs_sb_info *sbi)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">return</span> sbi-&gt;total_valid_block_count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">total_valid_block_count/user_block_count</span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">crash&gt; f2fs_sb_info  <span class="number">0xffffffc707cca000</span> | grep block_count</span><br><span class="line">  user_block_count = <span class="number">26074112</span>,</span><br><span class="line">  total_valid_block_count = <span class="number">26074112</span>,</span><br><span class="line">  last_valid_block_count = <span class="number">26074112</span>,</span><br><span class="line">  unusable_block_count = <span class="number">0</span>,</span><br><span class="line">  alloc_valid_block_count = &#123;</span><br><span class="line">  block_count = &#123;<span class="number">87</span>, <span class="number">267</span>&#125;,</span><br></pre></td></tr></table></figure>



<p>查看源码报错点发现是bind失败，继续分析bind内核源码</p>
<h3 id="用户态cnss报错函数"><a href="#用户态cnss报错函数" class="headerlink" title="用户态cnss报错函数"></a>用户态cnss报错函数</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">cnss_user_socket_init</span><span class="params">(<span class="type">int</span> sock_type)</span></span><br><span class="line">&#123;       </span><br><span class="line">        <span class="type">int</span> sockfd = <span class="number">-1</span>;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_un</span> <span class="title">un_address</span>;</span></span><br><span class="line">        <span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">switch</span> (sock_type) &#123;</span><br><span class="line">        <span class="keyword">case</span> AF_UNIX:</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">strlen</span>(CNSS_USER_SERVER) &gt;</span><br><span class="line">                    (<span class="keyword">sizeof</span>(un_address.sun_path) - <span class="number">1</span>)) &#123;</span><br><span class="line">                        wsvc_printf_err(<span class="string">&quot;Invalid server path %s\n&quot;</span>,</span><br><span class="line">                                        CNSS_USER_SERVER);</span><br><span class="line">                        ret = -EINVAL;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (access(CNSS_USER_SERVER, F_OK) == <span class="number">0</span>) &#123;</span><br><span class="line">                        wsvc_printf_info(<span class="string">&quot;server %s exists, remove it \n&quot;</span>,</span><br><span class="line">                                         CNSS_USER_SERVER);</span><br><span class="line">                        remove(CNSS_USER_SERVER);</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                sockfd = socket(AF_UNIX, SOCK_DGRAM, <span class="number">0</span>);</span><br><span class="line">                <span class="keyword">if</span> (sockfd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                        wsvc_printf_err(<span class="string">&quot;Fail to create user socket %s\n&quot;</span>,</span><br><span class="line">                                        strerror(errno));</span><br><span class="line">                        ret = -errno;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="built_in">memset</span>(&amp;un_address, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> sockaddr_un));</span><br><span class="line">                un_address.sun_family = AF_UNIX;</span><br><span class="line">                <span class="comment">//CNSS_USER_SERVER赋值给sun_path</span></span><br><span class="line">                strlcpy(un_address.sun_path, CNSS_USER_SERVER,</span><br><span class="line">                        (<span class="keyword">sizeof</span>(un_address.sun_path) - <span class="number">1</span>));</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (bind(sockfd, (<span class="keyword">struct</span> sockaddr *)&amp;un_address,</span><br><span class="line">                         <span class="keyword">sizeof</span>(un_address)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                        wsvc_printf_err(<span class="string">&quot;Fail to bind user socket %s\n&quot;</span>,</span><br><span class="line">                                        strerror(errno)); <span class="comment">//ERROR</span></span><br><span class="line">                        close(sockfd);</span><br><span class="line">                        sockfd = <span class="number">-1</span>;</span><br><span class="line">                        ret = -errno;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">                wsvc_printf_err(<span class="string">&quot;%s: Unknown sock type %d\n&quot;</span>,</span><br><span class="line">                                __func__, sock_type);</span><br><span class="line">                ret = -EINVAL;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        cnss_user_sock = sockfd;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="sun-path-CNSS-USER-SERVER"><a href="#sun-path-CNSS-USER-SERVER" class="headerlink" title="sun_path -&gt; CNSS_USER_SERVER"></a>sun_path -&gt; CNSS_USER_SERVER</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* LINUX/android/vendor/qcom/proprietary/wlan/cnss-daemon/cnss_cli.h */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> ANDROID</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CNSS_USER_SERVER <span class="string">&quot;/data/vendor/wifi/sockets/cnss_user_server&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CNSS_USER_CLIENT <span class="string">&quot;/data/vendor/wifi/sockets/cnss_user_client&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CNSS_USER_SERVER <span class="string">&quot;/var/run/cnss_user_server&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CNSS_USER_CLIENT <span class="string">&quot;/var/run/cnss_user_client&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>



<p>正常环境：</p>
<p><img src="C:\Users\rokid\AppData\Roaming\Typora\typora-user-images\image-20231030201034484.png" alt="image-20231030201034484"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">crash&gt; </span><span class="language-bash">ps | grep cnss</span></span><br><span class="line">     1392       1   5  ffffffcdafdbbb00  IN   0.1 12939508     9736  cnss-daemon</span><br><span class="line">     1446       1   2  ffffffcda12dd880  IN   0.1 12939508     9736  cnss-daemon</span><br><span class="line">     3676       1   6  ffffffcd8b220ec0  UN   0.1 12939508     9736  cnss-daemon</span><br><span class="line">     3904       1   1  ffffffcd7677e740  IN   0.1 12939508     9736  cnss-daemon</span><br><span class="line">     3978       1   5  ffffffcd72796740  UN   0.1 12939508     9736  cnss-daemon</span><br></pre></td></tr></table></figure>



<p>异常环境：没有cnss-daemon守护进程</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">crash&gt; </span><span class="language-bash">ps | grep cnss</span></span><br><span class="line">     1297       1   5  ffffffc6eaf83b00  IN   0.1 12927572     6560  cnss_diag</span><br></pre></td></tr></table></figure>



<p><code>cnss_diag</code> 和 <code>cnss-daemon</code> 是 Qualcomm 芯片上的两个不同的组件，它们在 Wi-Fi 和蓝牙功能的实现中扮演不同的角色。</p>
<p><code>cnss_diag</code> 是一个用于诊断 Qualcomm 芯片上 Wi-Fi 和蓝牙功能的工具，它可以帮助开发人员和工程师查找和解决与 Wi-Fi 和蓝牙相关的问题。它提供了一系列的命令和选项，可以用于获取和分析 Wi-Fi 和蓝牙的日志、统计信息和诊断数据等。</p>
<p><code>cnss-daemon</code> 是一个运行在 Qualcomm 芯片上的守护进程，它负责管理和控制 Wi-Fi 和蓝牙的硬件和软件资源。它与 Android 系统的 HAL 层和框架层进行交互，接收和处理来自应用程序和用户的 Wi-Fi 和蓝牙请求，同时也负责处理 Wi-Fi 和蓝牙的事件、状态和错误等。</p>
<h3 id="bind-unix"><a href="#bind-unix" class="headerlink" title="bind unix"></a>bind unix</h3><p>bind系统调用</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">SYSCALL_DEFINE3(bind, <span class="type">int</span>, fd, <span class="keyword">struct</span> sockaddr __user *, umyaddr, <span class="type">int</span>, addrlen)</span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">return</span> __sys_bind(fd, umyaddr, addrlen);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* net/socket.c */</span></span><br><span class="line"><span class="type">int</span> __sys_bind(<span class="type">int</span> fd, <span class="keyword">struct</span> sockaddr __user *umyaddr, <span class="type">int</span> addrlen)</span><br><span class="line">&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">socket</span> *<span class="title">sock</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_storage</span> <span class="title">address</span>;</span></span><br><span class="line">        <span class="type">int</span> err, fput_needed;</span><br><span class="line"></span><br><span class="line">        sock = sockfd_lookup_light(fd, &amp;err, &amp;fput_needed);</span><br><span class="line">        <span class="keyword">if</span> (sock) &#123;</span><br><span class="line">                err = move_addr_to_kernel(umyaddr, addrlen, &amp;address);</span><br><span class="line">                <span class="keyword">if</span> (err &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        err = security_socket_bind(sock,</span><br><span class="line">                                                   (<span class="keyword">struct</span> sockaddr *)&amp;address,</span><br><span class="line">                                                   addrlen);</span><br><span class="line">                        <span class="keyword">if</span> (!err)</span><br><span class="line">                                err = sock-&gt;ops-&gt;bind(sock, <span class="comment">//called</span></span><br><span class="line">                                                      (<span class="keyword">struct</span> sockaddr *)</span><br><span class="line">                                                      &amp;address, addrlen);</span><br><span class="line">                &#125;</span><br><span class="line">		...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="socket结构体"><a href="#socket结构体" class="headerlink" title="socket结构体"></a>socket结构体</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">crash&gt; </span><span class="language-bash">socket | grep ops</span></span><br><span class="line">    const struct proto_ops *ops;</span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* include/linux/socket.h */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PF_UNIX         AF_UNIX</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">proto_ops</span> <span class="title">unix_stream_ops</span> =</span> &#123;</span><br><span class="line">        .family =       PF_UNIX,</span><br><span class="line">        .owner =        THIS_MODULE,</span><br><span class="line">        .release =      unix_release,</span><br><span class="line">        .bind =         unix_bind, <span class="comment">//called</span></span><br><span class="line">		...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="bind底层调用关系"><a href="#bind底层调用关系" class="headerlink" title="bind底层调用关系"></a>bind底层调用关系</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">unix_bind</span><span class="params">(<span class="keyword">struct</span> socket *sock, <span class="keyword">struct</span> sockaddr *uaddr, <span class="type">int</span> addr_len)</span></span><br><span class="line">&#123;</span><br><span class="line">	...</span><br><span class="line">    <span class="comment">//sun_path来源于uaddr</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_un</span> *<span class="title">sunaddr</span> =</span> (<span class="keyword">struct</span> sockaddr_un *)uaddr;</span><br><span class="line">    <span class="type">char</span> *sun_path = sunaddr-&gt;sun_path;</span><br><span class="line">    ...</span><br><span class="line">	<span class="keyword">if</span> (addr_len == <span class="keyword">sizeof</span>(<span class="type">short</span>)) &#123;</span><br><span class="line">            err = unix_autobind(sock);</span><br><span class="line">            <span class="keyword">goto</span> out;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="unix-autobind"><a href="#unix-autobind" class="headerlink" title="unix_autobind"></a>unix_autobind</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">unix_autobind</span><span class="params">(<span class="keyword">struct</span> socket *sock)</span></span><br><span class="line">&#123;</span><br><span class="line">	...</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">unix_address</span> *<span class="title">addr</span>;</span></span><br><span class="line">    ...</span><br><span class="line">    addr = kzalloc(<span class="keyword">sizeof</span>(*addr) + <span class="keyword">sizeof</span>(<span class="type">short</span>) + <span class="number">16</span>, GFP_KERNEL);</span><br><span class="line">    addr-&gt;name-&gt;sun_family = AF_UNIX;</span><br><span class="line">    ...</span><br><span class="line">	<span class="keyword">if</span> (__unix_find_socket_byname(net, addr-&gt;name, addr-&gt;len, sock-&gt;type,</span><br><span class="line">                                      addr-&gt;hash)) &#123;</span><br><span class="line">            spin_unlock(&amp;unix_table_lock);</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * __unix_find_socket_byname() may take long time if many names</span></span><br><span class="line"><span class="comment">             * are already in use.</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            cond_resched();</span><br><span class="line">            <span class="comment">/* Give up if all names seems to be in use. */</span></span><br><span class="line">            <span class="keyword">if</span> (retries++ == <span class="number">0xFFFFF</span>) &#123;</span><br><span class="line">                    err = -ENOSPC;</span><br><span class="line">                    kfree(addr);</span><br><span class="line">                    <span class="keyword">goto</span> out;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">goto</span> retry;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">unix_address</span> &#123;</span></span><br><span class="line">    <span class="type">atomic_t</span> refcnt;</span><br><span class="line">    <span class="type">int</span> len;</span><br><span class="line">    <span class="type">unsigned</span> hash;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_un</span> <span class="title">name</span>[0];</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_un</span> &#123;</span></span><br><span class="line">        <span class="type">__kernel_sa_family_t</span> sun_family; <span class="comment">/* AF_UNIX */</span></span><br><span class="line">        <span class="type">char</span> sun_path[UNIX_PATH_MAX];   <span class="comment">/* pathname */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h4 id="unix-find-socket-byname"><a href="#unix-find-socket-byname" class="headerlink" title="__unix_find_socket_byname"></a>__unix_find_socket_byname</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *__<span class="title">unix_find_socket_byname</span>(<span class="keyword">struct</span> <span class="title">net</span> *<span class="title">net</span>,</span></span><br><span class="line"><span class="class">                                              <span class="keyword">struct</span> <span class="title">sockaddr_un</span> *<span class="title">sunname</span>,</span></span><br><span class="line"><span class="class">                                              <span class="title">int</span> <span class="title">len</span>, <span class="title">int</span> <span class="title">type</span>, <span class="title">unsigned</span> <span class="title">int</span> <span class="title">hash</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">s</span>;</span></span><br><span class="line"></span><br><span class="line">        sk_for_each(s, &amp;unix_socket_table[hash ^ type]) &#123;</span><br><span class="line">                <span class="class"><span class="keyword">struct</span> <span class="title">unix_sock</span> *<span class="title">u</span> =</span> unix_sk(s);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!net_eq(sock_net(s), net))</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">				<span class="comment">//sunname包含AF_UNIX和/data/vendor/wifi/sockets/cnss_user_server</span></span><br><span class="line">            	<span class="comment">//表示这个socket名一直被占用</span></span><br><span class="line">                <span class="keyword">if</span> (u-&gt;addr-&gt;len == len &amp;&amp;</span><br><span class="line">                    !<span class="built_in">memcmp</span>(u-&gt;addr-&gt;name, sunname, len)) <span class="comment">//memcmp为0表示u-&gt;addr-&gt;name == sunname</span></span><br><span class="line">                        <span class="keyword">goto</span> found;</span><br><span class="line">        &#125;</span><br><span class="line">        s = <span class="literal">NULL</span>;</span><br><span class="line">found:</span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> sk_for_each(__sk, list) \</span></span><br><span class="line"><span class="meta">        hlist_for_each_entry(__sk, list, sk_node)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * hlist_for_each_entry - iterate over list of given type</span></span><br><span class="line"><span class="comment"> * @pos:        the type * to use as a loop cursor.</span></span><br><span class="line"><span class="comment"> * @head:       the head for your list.</span></span><br><span class="line"><span class="comment"> * @member:     the name of the hlist_node within the struct.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> hlist_for_each_entry(pos, head, member)                         \</span></span><br><span class="line"><span class="meta">        for (pos = hlist_entry_safe((head)-&gt;first, typeof(*(pos)), member);\</span></span><br><span class="line"><span class="meta">             pos;                                                       \</span></span><br><span class="line"><span class="meta">             pos = hlist_entry_safe((pos)-&gt;member.next, typeof(*(pos)), member))</span></span><br></pre></td></tr></table></figure>



<h4 id="unix-socket-table"><a href="#unix-socket-table" class="headerlink" title="unix_socket_table"></a>unix_socket_table</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">unix_insert_socket</span><span class="params">(<span class="keyword">struct</span> hlist_head *<span class="built_in">list</span>, <span class="keyword">struct</span> sock *sk)</span></span><br><span class="line">&#123;</span><br><span class="line">        spin_lock(&amp;unix_table_lock);</span><br><span class="line">        __unix_insert_socket(<span class="built_in">list</span>, sk);</span><br><span class="line">        spin_unlock(&amp;unix_table_lock);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __unix_insert_socket(<span class="keyword">struct</span> hlist_head *<span class="built_in">list</span>, <span class="keyword">struct</span> sock *sk)</span><br><span class="line">&#123;</span><br><span class="line">        WARN_ON(!sk_unhashed(sk));</span><br><span class="line">        sk_add_node(sk, <span class="built_in">list</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">sk_add_node</span><span class="params">(<span class="keyword">struct</span> sock *sk, <span class="keyword">struct</span> hlist_head *<span class="built_in">list</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        sock_hold(sk);</span><br><span class="line">        __sk_add_node(sk, <span class="built_in">list</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> __sk_add_node(<span class="keyword">struct</span> sock *sk, <span class="keyword">struct</span> hlist_head *<span class="built_in">list</span>)</span><br><span class="line">&#123;</span><br><span class="line">        hlist_add_head(&amp;sk-&gt;sk_node, <span class="built_in">list</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> sk_node                 __sk_common.skc_node</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">hlist_add_head</span><span class="params">(<span class="keyword">struct</span> hlist_node *n, <span class="keyword">struct</span> hlist_head *h)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">hlist_node</span> *<span class="title">first</span> =</span> h-&gt;first;</span><br><span class="line">        n-&gt;next = first;</span><br><span class="line">        <span class="keyword">if</span> (first)</span><br><span class="line">                first-&gt;pprev = &amp;n-&gt;next;</span><br><span class="line">        WRITE_ONCE(h-&gt;first, n);</span><br><span class="line">        n-&gt;pprev = &amp;h-&gt;first;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">crash&gt; </span><span class="language-bash">sock_common -xo | grep skc_node</span></span><br><span class="line">  [0x68]     struct hlist_node skc_node;</span><br><span class="line"><span class="meta prompt_">crash&gt; </span><span class="language-bash">sock -xo | grep sock_common</span></span><br><span class="line">    [0x0] struct sock_common __sk_common;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">crash&gt; </span><span class="language-bash">unix_socket_table | grep -v 0x0 | grep first | <span class="built_in">head</span> -n 1</span></span><br><span class="line">    first = 0xffffffc59ddb5568</span><br><span class="line"></span><br><span class="line">first - 0x68 = sock</span><br></pre></td></tr></table></figure>



<p>解析unix_socket_table 居然没有cnss_user_server 不理解</p>
<blockquote>
<p>first &#x3D; 0xffffffc59ddb5568 &#x2F;dev&#x2F;socket&#x2F;property_service<br>first &#x3D; 0xffffffc7088004a8 &#x2F;dev&#x2F;socket&#x2F;logd<br>first &#x3D; 0xffffffc59ddb5de8 &#x2F;dev&#x2F;socket&#x2F;traced_consumer<br>first &#x3D; 0xffffffc59ddb4468 &#x2F;dev&#x2F;socket&#x2F;traced_producer<br>first &#x3D; 0xffffffc59ddb48a8 &#x2F;dev&#x2F;socket&#x2F;dpmd<br>first &#x3D; 0xffffffc59ddb7328 &#x2F;dev&#x2F;socket&#x2F;tcm<br>first &#x3D; 0xffffffc59ddb6668 &#x2F;dev&#x2F;socket&#x2F;dpmwrapper<br>first &#x3D; 0xffffffc708801e28 &#x2F;dev&#x2F;socket&#x2F;qwes_ipc<br>first &#x3D; 0xffffffc708a64028 &#x2F;dev&#x2F;socket&#x2F;ims_qmid<br>first &#x3D; 0xffffffc6efa6c028 &#x2F;dev&#x2F;socket&#x2F;location&#x2F;mq&#x2F;location-mq-s<br>first &#x3D; 0xffffffc708a61e28 &#x2F;dev&#x2F;socket&#x2F;thermal-send-client<br>first &#x3D; 0xffffffc708a62268 &#x2F;dev&#x2F;socket&#x2F;thermal-recv-client<br>first &#x3D; 0xffffffc708a60068 &#x2F;dev&#x2F;socket&#x2F;thermal-recv-passive-client<br>first &#x3D; 0xffffffc708a67ba8 &#x2F;dev&#x2F;socket&#x2F;thermal-send-rule<br>first &#x3D; 0xffffffc6e3bac468 &#x2F;dev&#x2F;socket&#x2F;ims_datad<br>first &#x3D; 0xffffffc708a66ee8 &#x2F;dev&#x2F;socket&#x2F;ipacm_log_file<br>first &#x3D; 0xffffffc59ddb7ba8 &#x2F;dev&#x2F;socket&#x2F;lmkd<br>first &#x3D; 0xffffffc708a648a8 &#x2F;dev&#x2F;socket&#x2F;ssgqmig<br>first &#x3D; 0xffffffc6dd5a6668 &#x2F;dev&#x2F;socket&#x2F;zygote<br>first &#x3D; 0xffffffc6dd5a6ee8 &#x2F;dev&#x2F;socket&#x2F;usap_pool_primary<br>first &#x3D; 0xffffffc708a65128 &#x2F;dev&#x2F;socket&#x2F;statsdw<br>first &#x3D; 0xffffffc6dd5a2268 &#x2F;dev&#x2F;socket&#x2F;zygote_secondary<br>first &#x3D; 0xffffffc6dd5a37a8 &#x2F;dev&#x2F;socket&#x2F;usap_pool_secondary<br>first &#x3D; 0xffffffc6dd5a48a8 &#x2F;dev&#x2F;socket&#x2F;dnsproxyd<br>first &#x3D; 0xffffffc6dd5a26a8 &#x2F;dev&#x2F;socket&#x2F;mdns<br>first &#x3D; 0xffffffc6dd5a59a8 &#x2F;dev&#x2F;socket&#x2F;fwmarkd<br>first &#x3D; 0xffffffc702bd0068 &#x2F;dev&#x2F;socket&#x2F;qvrservice_vndr<br>first &#x3D; 0xffffffc702bd7ba8 &#x2F;dev&#x2F;socket&#x2F;qvrservice_vndr_camera<br>first &#x3D; 0xffffffc708805de8 &#x2F;dev&#x2F;socket&#x2F;tombstoned_crash<br>first &#x3D; 0xffffffc708807328 &#x2F;dev&#x2F;socket&#x2F;tombstoned_intercept<br>first &#x3D; 0xffffffc708806668 &#x2F;dev&#x2F;socket&#x2F;tombstoned_java_trace<br>first &#x3D; 0xffffffc6e0996228 &#x2F;dev&#x2F;socket&#x2F;mlid<br>first &#x3D; 0xffffffc708a608e8 &#x2F;dev&#x2F;socket&#x2F;pps<br>first &#x3D; 0xffffffc6dd5a1e28 THERMALE_UIs0<br>first &#x3D; 0xffffffc6e0992268 &#x2F;dev&#x2F;socket&#x2F;adbd<br>first &#x3D; 0xffffffc6e3ba84a8 &#x2F;dev&#x2F;socket&#x2F;mdnsd<br>first &#x3D; 0xffffffc70bf4c468 &#x2F;dev&#x2F;socket&#x2F;port-bridge&#x2F;port_bridge_connect_socket<br>first &#x3D; 0xffffffc6d74ce228 &#x2F;data&#x2F;system&#x2F;unsolzygotesocket<br>first &#x3D; 0xffffffc6e3bad568 jdwp-control<br>first &#x3D; 0xffffffc708803be8 gplisnr</p>
</blockquote>
<h4 id="对比正常环境的unix-socket-table"><a href="#对比正常环境的unix-socket-table" class="headerlink" title="对比正常环境的unix_socket_table"></a>对比正常环境的unix_socket_table</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">PID: 1405     TASK: ffffffd55bc3d880  CPU: 6    COMMAND: &quot;cnss-daemon&quot;</span><br><span class="line">FD      SOCKET            SOCK       FAMILY:TYPE SOURCE-PORT DESTINATION-PORT</span><br><span class="line"> 4 ffffffd5b787cc00 ffffffd55bfba800 NETLINK/ROUTE:RAW </span><br><span class="line"> 5 ffffffd5b787d500 ffffffd588290440 UNIX:STREAM </span><br><span class="line"> 6 ffffffd5b787e700 ffffffd588292200 UNIX:STREAM </span><br><span class="line"> 7 ffffffd5b787e100 ffffffd588290000 UNIX:DGRAM  0</span><br><span class="line"> 8 ffffffd5b787c600 ffffffd55bfbd800 NETLINK/ROUTE:RAW </span><br><span class="line"> 9 ffffffd5b787ea00 ffffffd55bfbe000 NETLINK/ROUTE:RAW </span><br><span class="line">10 ffffffd565be5200 ffffffd5807ea000 NETLINK/ROUTE:RAW </span><br><span class="line">11 ffffffd565be7600 ffffffd5807ee800 NETLINK/ROUTE:RAW </span><br><span class="line">12 ffffffd565be6a00 ffffffd588326a40 UNIX:DGRAM   /data/vendor/wifi/sockets/cnss_user_server</span><br><span class="line">13 ffffffd565be7900 ffffffd5807e8000 NETLINK/ROUTE:RAW </span><br><span class="line">14 ffffffd570f50600 ffffffd581cf9a00 42:DGRAM  </span><br><span class="line">17 ffffffd541213600 ffffffd58b843a80 42:DGRAM  </span><br><span class="line">20 ffffffd53e1e7900 ffffffd581cfa080 42:DGRAM</span><br><span class="line"></span><br><span class="line">sock ffffffd588326a40</span><br><span class="line">first = sock + 0x68 = ffffffd588326aa8</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">crash&gt; </span><span class="language-bash">unix_socket_table | grep -v 0x0 | grep first | grep ffffffd588326aa8</span></span><br><span class="line">    first = 0xffffffd588326aa8</span><br><span class="line">    </span><br><span class="line">ffffffd588326a40 + 0x320 = ffffffd588326d60</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">crash&gt; </span><span class="language-bash">rd ffffffd588326d60</span></span><br><span class="line">ffffffd588326d60:  ffffffd564a38b00                    ...d....</span><br><span class="line"><span class="meta prompt_">crash&gt; </span><span class="language-bash">unix_address ffffffd564a38b00</span></span><br><span class="line">struct unix_address &#123;</span><br><span class="line">  refcnt = &#123;</span><br><span class="line">    refs = &#123;</span><br><span class="line">      counter = 1</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  len = 45,</span><br><span class="line">  hash = 256,</span><br><span class="line">  name = 0xffffffd564a38b0c</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_">crash&gt; </span><span class="language-bash">sockaddr_un 0xffffffd564a38b0c</span></span><br><span class="line">struct sockaddr_un &#123;</span><br><span class="line">  sun_family = 1,</span><br><span class="line">  sun_path = &quot;/data/vendor/wifi/sockets/cnss_user_server\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="反推并没有走到unix-autobind函数，再次审视unix-bind函数"><a href="#反推并没有走到unix-autobind函数，再次审视unix-bind函数" class="headerlink" title="反推并没有走到unix_autobind函数，再次审视unix_bind函数"></a>反推并没有走到unix_autobind函数，再次审视unix_bind函数</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">unix_bind</span><br><span class="line">&#123;</span><br><span class="line">	...</span><br><span class="line">	    err = unix_mkname(sunaddr, addr_len, &amp;hash);</span><br><span class="line">        <span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">goto</span> out;</span><br><span class="line">        addr_len = err;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (sun_path[<span class="number">0</span>]) &#123;</span><br><span class="line">                <span class="type">umode_t</span> mode = S_IFSOCK |</span><br><span class="line">                       (SOCK_INODE(sock)-&gt;i_mode &amp; ~current_umask());</span><br><span class="line">                err = unix_mknod(sun_path, mode, &amp;path);</span><br><span class="line">                <span class="keyword">if</span> (err) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (err == -EEXIST)</span><br><span class="line">                                err = -EADDRINUSE;</span><br><span class="line">                        <span class="keyword">goto</span> out;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        err = mutex_lock_interruptible(&amp;u-&gt;bindlock);</span><br><span class="line">        <span class="keyword">if</span> (err)</span><br><span class="line">                <span class="keyword">goto</span> out_put;</span><br><span class="line"></span><br><span class="line">        err = -EINVAL;</span><br><span class="line">        <span class="keyword">if</span> (u-&gt;addr)</span><br><span class="line">                <span class="keyword">goto</span> out_up;</span><br><span class="line"></span><br><span class="line">        err = -ENOMEM;</span><br><span class="line">        addr = kmalloc(<span class="keyword">sizeof</span>(*addr)+addr_len, GFP_KERNEL);</span><br><span class="line">        <span class="keyword">if</span> (!addr)</span><br><span class="line">                <span class="keyword">goto</span> out_up;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">memcpy</span>(addr-&gt;name, sunaddr, addr_len);</span><br><span class="line">        addr-&gt;len = addr_len;</span><br><span class="line">        addr-&gt;hash = hash ^ sk-&gt;sk_type;</span><br><span class="line">        refcount_set(&amp;addr-&gt;refcnt, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (sun_path[<span class="number">0</span>]) &#123;</span><br><span class="line">                addr-&gt;hash = UNIX_HASH_SIZE;</span><br><span class="line">                hash = d_backing_inode(path.dentry)-&gt;i_ino &amp; (UNIX_HASH_SIZE - <span class="number">1</span>);</span><br><span class="line">                spin_lock(&amp;unix_table_lock);</span><br><span class="line">                u-&gt;path = path;</span><br><span class="line">                <span class="built_in">list</span> = &amp;unix_socket_table[hash];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                spin_lock(&amp;unix_table_lock);</span><br><span class="line">                err = -EADDRINUSE;</span><br><span class="line">                <span class="keyword">if</span> (__unix_find_socket_byname(net, sunaddr, addr_len,</span><br><span class="line">                                              sk-&gt;sk_type, hash)) &#123;</span><br><span class="line">                        unix_release_addr(addr);</span><br><span class="line">                        <span class="keyword">goto</span> out_unlock;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="built_in">list</span> = &amp;unix_socket_table[addr-&gt;hash];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        err = <span class="number">0</span>;</span><br><span class="line">        __unix_remove_socket(sk);</span><br><span class="line">        smp_store_release(&amp;u-&gt;addr, addr);</span><br><span class="line">        __unix_insert_socket(<span class="built_in">list</span>, sk);</span><br><span class="line"></span><br><span class="line">out_unlock:</span><br><span class="line">        spin_unlock(&amp;unix_table_lock);</span><br><span class="line">out_up:</span><br><span class="line">        mutex_unlock(&amp;u-&gt;bindlock);</span><br><span class="line">out_put:</span><br><span class="line">        <span class="keyword">if</span> (err)</span><br><span class="line">                path_put(&amp;path);</span><br><span class="line">out:</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>根据返回值 关注unix_mkname unix_mknod</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">unix_mkname</span><span class="params">(<span class="keyword">struct</span> sockaddr_un *sunaddr, <span class="type">int</span> len, <span class="type">unsigned</span> <span class="type">int</span> *hashp)</span></span><br><span class="line">&#123;</span><br><span class="line">        *hashp = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (len &lt;= <span class="keyword">sizeof</span>(<span class="type">short</span>) || len &gt; <span class="keyword">sizeof</span>(*sunaddr))</span><br><span class="line">                <span class="keyword">return</span> -EINVAL;</span><br><span class="line">        <span class="keyword">if</span> (!sunaddr || sunaddr-&gt;sun_family != AF_UNIX)</span><br><span class="line">                <span class="keyword">return</span> -EINVAL;</span><br><span class="line">        <span class="keyword">if</span> (sunaddr-&gt;sun_path[<span class="number">0</span>]) &#123;</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 * This may look like an off by one error but it is a bit more</span></span><br><span class="line"><span class="comment">                 * subtle. 108 is the longest valid AF_UNIX path for a binding.</span></span><br><span class="line"><span class="comment">                 * sun_path[108] doesn&#x27;t as such exist.  However in kernel space</span></span><br><span class="line"><span class="comment">                 * we are guaranteed that it is a valid memory location in our</span></span><br><span class="line"><span class="comment">                 * kernel address buffer.</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                ((<span class="type">char</span> *)sunaddr)[len] = <span class="number">0</span>;</span><br><span class="line">                len = <span class="built_in">strlen</span>(sunaddr-&gt;sun_path)+<span class="number">1</span>+<span class="keyword">sizeof</span>(<span class="type">short</span>);</span><br><span class="line">                <span class="keyword">return</span> len;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        *hashp = unix_hash_fold(csum_partial(sunaddr, len, <span class="number">0</span>));</span><br><span class="line">        <span class="keyword">return</span> len;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>unix_mkname没有ENOSPC</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">unix_mknod</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *sun_path, <span class="type">umode_t</span> mode, <span class="keyword">struct</span> path *res)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> *<span class="title">dentry</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">path</span> <span class="title">path</span>;</span></span><br><span class="line">        <span class="type">int</span> err = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Get the parent directory, calculate the hash for last</span></span><br><span class="line"><span class="comment">         * component.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        dentry = kern_path_create(AT_FDCWD, sun_path, &amp;path, <span class="number">0</span>);</span><br><span class="line">        err = PTR_ERR(dentry);</span><br><span class="line">        <span class="keyword">if</span> (IS_ERR(dentry))</span><br><span class="line">                <span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * All right, let&#x27;s create it.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        err = security_path_mknod(&amp;path, dentry, mode, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (!err) &#123;</span><br><span class="line">                err = vfs_mknod(d_inode(path.dentry), dentry, mode, <span class="number">0</span>);</span><br><span class="line">                <span class="keyword">if</span> (!err) &#123;</span><br><span class="line">                        res-&gt;mnt = mntget(path.mnt);</span><br><span class="line">                        res-&gt;dentry = dget(dentry);</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        done_path_create(&amp;path, dentry);</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> dentry *<span class="title function_">kern_path_create</span><span class="params">(<span class="type">int</span> dfd, <span class="type">const</span> <span class="type">char</span> *pathname,</span></span><br><span class="line"><span class="params">                                <span class="keyword">struct</span> path *path, <span class="type">unsigned</span> <span class="type">int</span> lookup_flags)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">return</span> filename_create(dfd, getname_kernel(pathname),</span><br><span class="line">                                path, lookup_flags);</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(kern_path_create);</span><br></pre></td></tr></table></figure>

<p>filename_create会去创建文件或者目录，会在data分区下面尝试写入，但是由于空间不足导致ENOSPC</p>
<h4 id="一句话结论"><a href="#一句话结论" class="headerlink" title="一句话结论"></a>一句话结论</h4><p>cnss等待加载fw超时，超时原因又是cnss daemon创建socket失败创建socket，也需要写入 socket fd</p>
<h3 id="那么谁占用了data分区？"><a href="#那么谁占用了data分区？" class="headerlink" title="那么谁占用了data分区？"></a>那么谁占用了data分区？</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">crash&gt; </span><span class="language-bash">mount | grep data</span></span><br><span class="line">ffffffc70cd3ad80 ffffffc59e09f800 ext4   /dev/block/by-name/metadata /metadata </span><br><span class="line">ffffffc70cd3b640 ffffffc59e3c7000 ext4   /dev/block/dm-10 /apex/com.android.tzdata</span><br><span class="line">ffffffc736581180 ffffffc70bdfe000 f2fs   /dev/block/dm-15 /data  </span><br></pre></td></tr></table></figure>

<p>得到&#x2F;data的super_block结构体地址</p>
<h4 id="super-block与f2fs-sb-info的联系"><a href="#super-block与f2fs-sb-info的联系" class="headerlink" title="super_block与f2fs_sb_info的联系"></a>super_block与f2fs_sb_info的联系</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="keyword">struct</span> f2fs_sb_info *<span class="title function_">F2FS_SB</span><span class="params">(<span class="keyword">struct</span> super_block *sb)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> sb-&gt;s_fs_info;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//偏移0x440</span></span><br><span class="line">crash&gt; super_block -xo | grep s_fs_info</span><br><span class="line">  [<span class="number">0x440</span>] <span class="type">void</span> *s_fs_info;</span><br><span class="line"></span><br><span class="line">s_fs_info: ffffffc70bdfe000 + <span class="number">0x440</span> = ffffffc70bdfe440</span><br><span class="line"></span><br><span class="line"><span class="comment">//s_fs_info是指针，需要rd取内容</span></span><br><span class="line">crash&gt; rd ffffffc70bdfe440</span><br><span class="line">ffffffc70bdfe440:  ffffffc707cca000                    ........</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> f2fs_sb_info : <span class="number">0xffffffc707cca000</span> </span><br></pre></td></tr></table></figure>



<p>反推可以证明f2fs_sb_info地址的准确性</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">f2fs_sb_info</span> &#123;</span></span><br><span class="line">    [<span class="number">0x0</span>] <span class="class"><span class="keyword">struct</span> <span class="title">super_block</span> *<span class="title">sb</span>;</span></span><br><span class="line"></span><br><span class="line">crash&gt; rd <span class="number">0xffffffc707cca000</span></span><br><span class="line">ffffffc707cca000:  ffffffc70bdfe000                    ........</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">super_block</span> :</span> ffffffc70bdfe000</span><br></pre></td></tr></table></figure>



<h4 id="f2fs-superblock结构"><a href="#f2fs-superblock结构" class="headerlink" title="f2fs superblock结构"></a>f2fs superblock结构</h4><p><img src="https://github.com/RiweiPan/F2FS-NOTES/raw/master/img/F2FS-Layout/sb_layout2.png" alt="sb_layout"></p>
<p>整个磁盘区域被F2FS设计为6个区域：</p>
<p>分别是Superblock，Checkpoint，Segment Info Table，Node Address Table，Segment Summary Area，以及<strong>Main Area</strong>。</p>
<p>前5个区域总称为元数据区域，保存的是跟F2FS直接相关的元信息，而最后一个区域是<strong>保存文件数据的主要区域</strong>。</p>
<p>block: 4KB对齐且连续的物理存储空间<br>segment: 2M连续的物理存储空间</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">struct f2fs_sb_info &#123;</span><br><span class="line">    [0x0] struct super_block *sb;</span><br><span class="line">    [0x8] struct proc_dir_entry *s_proc;</span><br><span class="line">   [0x10] struct f2fs_super_block *raw_super;</span><br><span class="line">   </span><br><span class="line"><span class="meta prompt_">crash&gt; </span><span class="language-bash">rd 0xffffffc707cca010</span></span><br><span class="line">ffffffc707cca010:  ffffffc707cc9000                    ........</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">crash&gt; </span><span class="language-bash">f2fs_super_block  ffffffc707cc9000</span></span><br><span class="line">struct f2fs_super_block &#123;</span><br><span class="line">  magic = 4076150800,</span><br><span class="line">  major_ver = 1,</span><br><span class="line">  minor_ver = 13,</span><br><span class="line">  log_sectorsize = 12,</span><br><span class="line">  log_sectors_per_block = 0,</span><br><span class="line">  log_blocksize = 12,</span><br><span class="line">  log_blocks_per_seg = 9,</span><br><span class="line">  segs_per_sec = 1,</span><br><span class="line">  secs_per_zone = 1,</span><br><span class="line">  checksum_offset = 0,</span><br><span class="line">  block_count = 26520121,</span><br><span class="line">  section_count = 51573,</span><br><span class="line">  segment_count = 51796,</span><br><span class="line">  segment_count_ckpt = 2,</span><br><span class="line">  segment_count_sit = 4,</span><br><span class="line">  segment_count_nat = 116,</span><br><span class="line">  segment_count_ssa = 101,</span><br><span class="line">  segment_count_main = 51573, //51573*2MB=100GB</span><br><span class="line">  segment0_blkaddr = 512,</span><br><span class="line">  cp_blkaddr = 512,</span><br><span class="line">  sit_blkaddr = 1536,</span><br><span class="line">  nat_blkaddr = 3584,</span><br><span class="line">  ssa_blkaddr = 62976,</span><br><span class="line">  main_blkaddr = 114688,</span><br><span class="line">  root_ino = 3,</span><br><span class="line">  node_ino = 1,</span><br><span class="line">  meta_ino = 2,</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>



<h4 id="疑问点：为啥没有gc出空间"><a href="#疑问点：为啥没有gc出空间" class="headerlink" title="疑问点：为啥没有gc出空间"></a>疑问点：为啥没有gc出空间</h4><p>垃圾回收在F2FS中，主要作用是回收无效的block，以供用户重新使用</p>
<p>[F2FS源码分析-4.1 <a target="_blank" rel="noopener" href="https://blog.csdn.net/u011649400/article/details/100530006">F2FS GC部分] 垃圾回收机制源码分析-CSDN博客</a></p>
<h4 id="【换个思路】从进程打开的文件角度看"><a href="#【换个思路】从进程打开的文件角度看" class="headerlink" title="【换个思路】从进程打开的文件角度看"></a>【换个思路】从进程打开的文件角度看</h4><p>foreach files 命令可以看到所有进程打开的文件路径，dentry，inode地址</p>
<p>过滤&#x2F;data目录后得到</p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/38919652/1699512190654-1f0f0643-c723-43d9-9797-769df05bbfff.png?x-oss-process=image/resize,w_750,limit_0" alt="image.png"></p>
<p>根据inode地址推导出文件i_size大小，单位为字节，最大文件为30M左右</p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/38919652/1699512198798-efb86cd3-7c50-4b8a-baf3-128d965e4e5e.png" alt="image.png"></p>
<h4 id="一句话结论-1"><a href="#一句话结论-1" class="headerlink" title="一句话结论"></a>一句话结论</h4><p>&#x2F;data目录下打开的文件属于正常，所以导致data分区满的原因不是系统进程创建的文件，推测是外部导入的</p>
<h3 id="如何复现"><a href="#如何复现" class="headerlink" title="如何复现"></a>如何复现</h3><p>先使用dd命令把data分区塞满，命令如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dd if=/dev/zero of=/data/test bs=1g count=100</span><br></pre></td></tr></table></figure>

<p>若还剩M级别或者k级别的内存空间，将bs&#x3D;1g换成1m或者1k来继续填满【记得修改of后面的文件名】</p>
<p>之后就让设备放着跑，过会就复现红灯了</p>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p>1、<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/640917510">f2fs文件系统（八）文件布局 - 知乎 (zhihu.com)</a></p>

        
        <br />
        <div id="comment-container">
        </div>
        <div id="disqus_thread"></div>
        <div id="lv-container"></div>
        <div class="giscus"></div>
    </div>
</div>

    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        

        

    </ul>
    
    <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>
        Created By <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>  Theme <a target="_blank" rel="noopener" href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a></p>
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = ""
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>

<script src="/js/index.js"></script>

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>






</html>
